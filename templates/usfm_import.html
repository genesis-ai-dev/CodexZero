{% extends "base.html" %}

{% block title %}USFM Import - {{ project.target_language }} Translation - CodexZero{% endblock %}

{% block content %}
<section class="min-h-screen">
    <!-- Clean Header -->
    <div class="max-w-5xl mx-auto px-4 sm:px-6 py-4 sm:py-8">
        <div class="bg-white/80 backdrop-blur-sm rounded-2xl shadow-lg border border-white/20 p-4 sm:p-8 mb-6 sm:mb-8">
            <div class="flex flex-col lg:flex-row lg:items-center justify-between gap-4">
                <div class="min-w-0 flex-1">
                    <div class="flex flex-wrap items-center text-sm text-neutral-600 mb-2 font-medium">
                        <a href="{{ url_for('projects.view_project', project_id=project.id) }}" class="hover:text-neutral-900 transition-colors">
                            <i class="fas fa-arrow-left mr-2"></i>
                            Back to Project
                        </a>
                        <span class="mx-2">→</span>
                        <span class="truncate">USFM Import</span>
                    </div>
                    <h1 class="text-2xl sm:text-3xl font-bold text-neutral-900 mb-2 break-words">USFM Import</h1>
                    <p class="text-neutral-700 font-medium text-base sm:text-lg">{{ project.target_language }} Translation • {{ project.audience }} • {{ project.style }} style</p>
                </div>
            </div>
        </div>

        <!-- Progress Overview -->
        <div class="bg-white/80 backdrop-blur-sm rounded-2xl shadow-lg border border-white/20 p-4 sm:p-8 mb-6 sm:mb-8">
            <div class="mb-6">
                <h2 class="text-xl sm:text-2xl font-bold text-neutral-900 mb-2">Bible Progress</h2>
                <p class="text-neutral-600 font-medium">Track your translation completion</p>
            </div>
            
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-lg font-bold text-neutral-900">Translation Completion</h3>
                <div class="text-2xl font-bold text-purple-600">
                    <span id="completion-percentage">0.0%</span>
                </div>
            </div>
            
            <!-- Progress Bar -->
            <div class="w-full bg-neutral-200 rounded-full h-4 mb-6">
                <div id="progress-bar" class="bg-purple-600 h-full transition-all duration-500 rounded-full" style="width: 0%"></div>
            </div>
            
            <!-- Stats -->
            <div class="flex justify-center space-x-8 sm:space-x-12 text-center">
                <div>
                    <div class="text-2xl sm:text-3xl font-bold text-green-600" id="filled-verses">0</div>
                    <div class="text-sm text-neutral-600 font-medium">Verses Completed</div>
                </div>
                <div class="text-neutral-400 text-xl sm:text-2xl font-bold">of</div>
                <div>
                    <div class="text-2xl sm:text-3xl font-bold text-neutral-700" id="total-verses">0</div>
                    <div class="text-sm text-neutral-600 font-medium">Total Verses</div>
                </div>
            </div>
        </div>

        <!-- Main Content Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 sm:gap-8 mb-6 sm:mb-8">
            <!-- Upload Section -->
            <div class="bg-white/80 backdrop-blur-sm rounded-2xl shadow-lg border border-white/20 p-4 sm:p-8">
                <div class="flex items-center mb-6">
                    <div class="w-10 h-10 sm:w-12 sm:h-12 bg-purple-100 rounded-xl flex items-center justify-center mr-3 sm:mr-4">
                        <i class="fas fa-upload text-purple-600 text-lg"></i>
                    </div>
                    <div>
                        <h3 class="text-lg sm:text-xl font-bold text-neutral-900">Add USFM Files</h3>
                        <p class="text-neutral-700 text-sm mt-1 font-medium">Upload USFM/SFM files to build your Bible</p>
                    </div>
                </div>
                
                <div class="space-y-4">
                    <div class="border-2 border-dashed border-neutral-300 rounded-xl p-4 hover:border-purple-400 hover:bg-purple-50/50 transition-all duration-200">
                        <input type="file" 
                               id="usfm-files" 
                               accept=".usfm,.sfm" 
                               multiple 
                               class="block w-full text-sm text-neutral-500 file:mr-4 file:py-2 file:px-4 file:border-0 file:rounded-lg file:bg-purple-50 file:text-sm file:font-medium file:text-purple-600 hover:file:bg-purple-100 transition-colors">
                    </div>
                    
                    <button id="upload-btn" class="w-full px-6 py-3 bg-gradient-to-r from-purple-600 to-purple-700 text-white hover:from-purple-700 hover:to-purple-800 rounded-xl font-semibold transition-all duration-200 shadow-lg">
                        <i class="fas fa-upload mr-2"></i>
                        Upload & Add to Bible
                    </button>
                    
                    <div class="text-xs text-neutral-500 text-center font-medium">
                        Supports .usfm and .sfm files • Upload books individually or all at once
                    </div>
                </div>
            </div>

            <!-- Uploaded Files -->
            <div class="bg-white/80 backdrop-blur-sm rounded-2xl shadow-lg border border-white/20 p-4 sm:p-8">
                <div class="flex items-center mb-6">
                    <div class="w-10 h-10 sm:w-12 sm:h-12 bg-green-100 rounded-xl flex items-center justify-center mr-3 sm:mr-4">
                        <i class="fas fa-file-code text-green-600 text-lg"></i>
                    </div>
                    <div>
                        <h3 class="text-lg sm:text-xl font-bold text-neutral-900">Files Added</h3>
                        <p class="text-neutral-700 text-sm mt-1 font-medium">Track your uploaded USFM files</p>
                    </div>
                </div>
                
                <div id="uploaded-files-list" class="space-y-3 max-h-64 overflow-y-auto">
                    <div id="no-files-message" class="text-center py-6 sm:py-8">
                        <div class="w-12 h-12 sm:w-16 sm:h-16 bg-neutral-100 rounded-xl flex items-center justify-center mx-auto mb-4">
                            <i class="fas fa-file-code text-neutral-400 text-lg sm:text-xl"></i>
                        </div>
                        <h4 class="text-base sm:text-lg font-bold mb-2 text-neutral-900">No files uploaded yet</h4>
                        <p class="text-neutral-600 text-sm font-medium">Upload USFM files to get started</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Complete Section -->
        <div class="bg-white/80 backdrop-blur-sm rounded-2xl shadow-lg border border-white/20 p-4 sm:p-8">
            <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-4">
                <div class="flex items-center">
                    <div class="w-10 h-10 sm:w-12 sm:h-12 bg-green-100 rounded-xl flex items-center justify-center mr-3 sm:mr-4">
                        <i class="fas fa-check-circle text-green-600 text-lg"></i>
                    </div>
                    <div>
                        <h3 class="text-lg sm:text-xl font-bold text-neutral-900">Create eBible File</h3>
                        <p class="text-neutral-700 text-sm mt-1 font-medium">Complete the import when you have all the books you need</p>
                    </div>
                </div>
                
                <button id="complete-btn" class="w-full sm:w-auto px-6 py-3 bg-gradient-to-r from-green-600 to-green-700 text-white hover:from-green-700 hover:to-green-800 rounded-xl font-semibold transition-all duration-200 shadow-lg opacity-50 cursor-not-allowed" disabled>
                    <i class="fas fa-check mr-2"></i>
                    Complete Import
                </button>
            </div>
        </div>
    </div>
</section>
{% endblock %}

{% block scripts %}
<script>
    const projectId = {{ project.id }};
    let uploadedFiles = [];
    let currentStats = { total_verses: 0, filled_verses: 0, missing_verses: 0, completion_percentage: 0 };

    // DOM Elements
    const uploadBtn = document.getElementById('upload-btn');
    const completeBtn = document.getElementById('complete-btn');
    const fileInput = document.getElementById('usfm-files');
    const uploadedFilesList = document.getElementById('uploaded-files-list');
    const noFilesMessage = document.getElementById('no-files-message');

    // Progress elements
    const progressBar = document.getElementById('progress-bar');
    const completionPercentage = document.getElementById('completion-percentage');
    const filledVerses = document.getElementById('filled-verses');
    const totalVerses = document.getElementById('total-verses');

    // Upload button handler
    uploadBtn.addEventListener('click', function() {
        const files = fileInput.files;
        if (files.length === 0) {
            showMessage('Please select at least one USFM file', 'error');
            return;
        }
        
        uploadFiles(files);
    });

    // Complete button handler
    completeBtn.addEventListener('click', function() {
        if (uploadedFiles.length === 0) {
            showMessage('Please upload at least one USFM file before completing', 'error');
            return;
        }
        
        completeImport();
    });

    function uploadFiles(files) {
        uploadBtn.disabled = true;
        uploadBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Uploading...';
        uploadBtn.classList.add('opacity-50', 'cursor-not-allowed');
        
        const formData = new FormData();
        
        // Add all files
        for (let i = 0; i < files.length; i++) {
            formData.append('usfm_files', files[i]);
        }
        
        fetch(`/project/${projectId}/usfm-upload`, {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Show success message and redirect
                showMessage(data.message, 'success');
                
                // Redirect to project page after success
                setTimeout(() => {
                    window.location.href = `/project/${projectId}`;
                }, 1500);
                
            } else {
                showMessage(data.error || 'Upload failed', 'error');
            }
        })
        .catch(error => {
            console.error('Upload error:', error);
            showMessage('Upload failed: ' + error.message, 'error');
        })
        .finally(() => {
            uploadBtn.disabled = false;
            uploadBtn.innerHTML = '<i class="fas fa-upload mr-2"></i>Upload & Add to Bible';
            uploadBtn.classList.remove('opacity-50', 'cursor-not-allowed');
        });
    }

    function addUploadedFile(file) {
        // Hide no files message
        if (noFilesMessage) {
            noFilesMessage.remove();
        }
        
        // Create file element
        const fileElement = document.createElement('div');
        fileElement.className = 'bg-white/90 border border-neutral-200 rounded-xl p-4 flex items-center justify-between hover:shadow-md transition-all duration-200';
        fileElement.innerHTML = `
            <div class="flex items-center min-w-0 flex-1">
                <div class="w-8 h-8 bg-green-100 rounded-lg flex items-center justify-center mr-3 flex-shrink-0">
                    <i class="fas fa-file-code text-green-600 text-sm"></i>
                </div>
                <div class="min-w-0 flex-1">
                    <div class="font-medium text-sm text-neutral-900 truncate">${file.filename}</div>
                    <div class="text-xs text-neutral-600 font-medium">${file.verses_count} verses • ${file.books.join(', ')}</div>
                </div>
            </div>
            <div class="text-xs text-green-600 font-bold bg-green-50 px-2 py-1 rounded-lg flex-shrink-0">Added</div>
        `;
        
        uploadedFilesList.appendChild(fileElement);
        uploadedFiles.push(file);
        
        // Enable complete button if files uploaded
        if (uploadedFiles.length > 0) {
            completeBtn.disabled = false;
            completeBtn.classList.remove('opacity-50', 'cursor-not-allowed');
        }
    }

    function updateProgress(stats) {
        currentStats = stats;
        
        // Update progress bar
        progressBar.style.width = `${stats.completion_percentage}%`;
        
        // Update text values
        completionPercentage.textContent = `${stats.completion_percentage.toFixed(1)}%`;
        filledVerses.textContent = stats.filled_verses.toLocaleString();
        totalVerses.textContent = stats.total_verses.toLocaleString();
    }

    function completeImport() {
        completeBtn.disabled = true;
        completeBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Completing...';
        completeBtn.classList.add('opacity-50', 'cursor-not-allowed');
        
        fetch(`/project/${projectId}/usfm-complete`, {
            method: 'POST'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showMessage(data.message, 'success');
                
                // Redirect to project page after a short delay
                setTimeout(() => {
                    window.location.href = `/project/${projectId}`;
                }, 2000);
                
            } else {
                showMessage(data.error || 'Completion failed', 'error');
                completeBtn.disabled = false;
                completeBtn.innerHTML = '<i class="fas fa-check mr-2"></i>Complete Import';
                completeBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            }
        })
        .catch(error => {
            console.error('Completion error:', error);
            showMessage('Completion failed: ' + error.message, 'error');
            completeBtn.disabled = false;
            completeBtn.innerHTML = '<i class="fas fa-check mr-2"></i>Complete Import';
            completeBtn.classList.remove('opacity-50', 'cursor-not-allowed');
        });
    }

    function showMessage(message, type) {
        // Create message element
        const messageElement = document.createElement('div');
        messageElement.className = `fixed top-4 right-4 p-4 rounded-xl shadow-lg border z-50 max-w-sm ${
            type === 'success' 
                ? 'bg-green-50 border-green-200 text-green-800' 
                : 'bg-red-50 border-red-200 text-red-800'
        }`;
        messageElement.innerHTML = `
            <div class="flex items-center space-x-2">
                <i class="fas ${type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle'} flex-shrink-0"></i>
                <span class="font-medium text-sm">${message}</span>
            </div>
        `;
        
        document.body.appendChild(messageElement);
        
        // Remove after 5 seconds
        setTimeout(() => {
            messageElement.remove();
        }, 5000);
    }

    // Load existing progress on page load
    fetch(`/project/${projectId}/usfm-status`)
        .then(response => response.json())
        .then(data => {
            if (data.stats) {
                updateProgress(data.stats);
            }
            if (data.uploaded_files && data.uploaded_files.length > 0) {
                data.uploaded_files.forEach(file => {
                    addUploadedFile(file);
                });
            }
        })
        .catch(error => {
            console.error('Error loading status:', error);
        });
</script>
{% endblock %} 