{% extends "base.html" %}

{% block title %}USFM Import - {{ project.target_language }} Translation - CodexZero{% endblock %}

{% block content %}
<section class="min-h-screen paper-white">
    <!-- Header -->
    <div class="paper-cream border-b marker-border-thin">
        <div class="max-w-7xl mx-auto px-8 py-6">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-6">
                    <a href="{{ url_for('view_project', project_id=project.id) }}" class="nav-link text-sm font-medium">
                        <i class="fas fa-arrow-left mr-2"></i>
                        Back to Project
                    </a>
                    <div class="h-6 w-px marker-border-thin"></div>
                    <div>
                        <h1 class="text-3xl font-bold" style="color: #2d2d2d;">USFM Import</h1>
                        <p class="text-sm text-neutral-700 mt-1 font-medium">{{ project.target_language }} Translation • {{ project.audience }} • {{ project.style }} style</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="max-w-7xl mx-auto px-8 py-8">
        
        <!-- Progress Overview -->
        <div class="mb-8">
            <h2 class="text-2xl font-bold mb-6" style="color: #2d2d2d;">Bible Progress</h2>
            <div class="paper-cream p-8 marker-border">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-xl font-bold" style="color: #2d2d2d;">Translation Completion</h3>
                    <div class="text-2xl font-bold text-purple-600">
                        <span id="completion-percentage">0.0%</span>
                    </div>
                </div>
                
                <!-- Progress Bar -->
                <div class="w-full paper-light marker-border-thin h-6 mb-6">
                    <div id="progress-bar" class="bg-purple-600 h-full transition-all duration-500 marker-border-thin" style="width: 0%"></div>
                </div>
                
                <!-- Stats -->
                <div class="flex justify-center space-x-12 text-center">
                    <div>
                        <div class="text-3xl font-bold text-green-600" id="filled-verses">0</div>
                        <div class="text-sm text-neutral-600 font-medium">Verses Completed</div>
                    </div>
                    <div class="text-neutral-400 text-2xl font-bold">of</div>
                    <div>
                        <div class="text-3xl font-bold text-neutral-700" id="total-verses">31,170</div>
                        <div class="text-sm text-neutral-600 font-medium">Total Verses</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
            <!-- Upload Section -->
            <div class="paper-cream p-8 marker-border">
                <div class="flex items-center mb-6">
                    <div class="w-12 h-12 paper-light marker-border-thin flex items-center justify-center mr-4">
                        <i class="fas fa-upload text-purple-600 text-lg"></i>
                    </div>
                    <div>
                        <h3 class="text-xl font-bold" style="color: #2d2d2d;">Add USFM Files</h3>
                        <p class="text-neutral-700 text-sm mt-1 font-medium">Upload USFM/SFM files to build your Bible</p>
                    </div>
                </div>
                
                <div class="space-y-4">
                    <div class="paper-white p-4 marker-border-thin">
                        <input type="file" 
                               id="usfm-files" 
                               accept=".usfm,.sfm,.txt" 
                               multiple 
                               class="block w-full text-sm text-neutral-500 file:mr-4 file:py-2 file:px-4 file:marker-border-thin file:paper-light file:text-sm file:font-medium file:text-purple-600 hover:file:bg-purple-50 transition-colors">
                    </div>
                    
                    <button id="upload-btn" class="btn-marker w-full text-sm">
                        <i class="fas fa-upload mr-2"></i>
                        Upload & Add to Bible
                    </button>
                    
                    <div class="text-xs text-neutral-500 text-center font-medium">
                        Supports .usfm, .sfm, and .txt files • Upload books individually or all at once
                    </div>
                </div>
            </div>

            <!-- Uploaded Files -->
            <div class="paper-cream p-8 marker-border">
                <div class="flex items-center mb-6">
                    <div class="w-12 h-12 paper-light marker-border-thin flex items-center justify-center mr-4">
                        <i class="fas fa-file-code text-green-600 text-lg"></i>
                    </div>
                    <div>
                        <h3 class="text-xl font-bold" style="color: #2d2d2d;">Files Added</h3>
                        <p class="text-neutral-700 text-sm mt-1 font-medium">Track your uploaded USFM files</p>
                    </div>
                </div>
                
                <div id="uploaded-files-list" class="space-y-3 max-h-64 overflow-y-auto">
                    <div id="no-files-message" class="text-center py-8">
                        <div class="w-16 h-16 paper-light marker-border-thin flex items-center justify-center mx-auto mb-4">
                            <i class="fas fa-file-code text-neutral-400 text-xl"></i>
                        </div>
                        <h4 class="text-lg font-bold mb-2" style="color: #2d2d2d;">No files uploaded yet</h4>
                        <p class="text-neutral-600 text-sm font-medium">Upload USFM files to get started</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Complete Section -->
        <div class="paper-cream p-8 marker-border">
            <div class="flex items-center justify-between">
                <div class="flex items-center">
                    <div class="w-12 h-12 paper-light marker-border-thin flex items-center justify-center mr-4">
                        <i class="fas fa-check-circle text-green-600 text-lg"></i>
                    </div>
                    <div>
                        <h3 class="text-xl font-bold" style="color: #2d2d2d;">Create eBible File</h3>
                        <p class="text-neutral-700 text-sm mt-1 font-medium">Complete the import when you have all the books you need</p>
                    </div>
                </div>
                
                <button id="complete-btn" class="btn-marker text-sm" disabled>
                    <i class="fas fa-check mr-2"></i>
                    Complete Import
                </button>
            </div>
        </div>
    </div>
</section>
{% endblock %}

{% block scripts %}
<script>
    const projectId = {{ project.id }};
    let uploadedFiles = [];
    let currentStats = {
        total_verses: 31170,
        filled_verses: 0,
        missing_verses: 31170,
        completion_percentage: 0
    };

    // DOM Elements
    const uploadBtn = document.getElementById('upload-btn');
    const completeBtn = document.getElementById('complete-btn');
    const fileInput = document.getElementById('usfm-files');
    const uploadedFilesList = document.getElementById('uploaded-files-list');
    const noFilesMessage = document.getElementById('no-files-message');

    // Progress elements
    const progressBar = document.getElementById('progress-bar');
    const completionPercentage = document.getElementById('completion-percentage');
    const filledVerses = document.getElementById('filled-verses');

    // Upload button handler
    uploadBtn.addEventListener('click', function() {
        const files = fileInput.files;
        if (files.length === 0) {
            showMessage('Please select at least one USFM file', 'error');
            return;
        }
        
        uploadFiles(files);
    });

    // Complete button handler
    completeBtn.addEventListener('click', function() {
        if (uploadedFiles.length === 0) {
            showMessage('Please upload at least one USFM file before completing', 'error');
            return;
        }
        
        completeImport();
    });

    function uploadFiles(files) {
        uploadBtn.disabled = true;
        uploadBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Uploading...';
        uploadBtn.classList.add('opacity-50', 'cursor-not-allowed');
        
        const formData = new FormData();
        
        // Add all files
        for (let i = 0; i < files.length; i++) {
            formData.append('usfm_files', files[i]);
        }
        
        fetch(`/project/${projectId}/usfm-upload`, {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Add uploaded files to list
                data.uploaded_files.forEach(file => {
                    addUploadedFile(file);
                });
                
                // Update progress
                updateProgress(data.stats);
                
                // Clear file input
                fileInput.value = '';
                
                // Show success message
                showMessage(data.message, 'success');
                
            } else {
                showMessage(data.error || 'Upload failed', 'error');
            }
        })
        .catch(error => {
            console.error('Upload error:', error);
            showMessage('Upload failed: ' + error.message, 'error');
        })
        .finally(() => {
            uploadBtn.disabled = false;
            uploadBtn.innerHTML = '<i class="fas fa-upload mr-2"></i>Upload & Add to Bible';
            uploadBtn.classList.remove('opacity-50', 'cursor-not-allowed');
        });
    }

    function addUploadedFile(file) {
        // Hide no files message
        noFilesMessage.classList.add('hidden');
        
        // Create file element
        const fileElement = document.createElement('div');
        fileElement.className = 'flex items-center justify-between p-4 paper-white marker-border-thin hover:paper-light transition-colors';
        fileElement.innerHTML = `
            <div class="flex items-center space-x-3">
                <i class="fas fa-check-circle text-green-600"></i>
                <div>
                    <div class="font-bold text-sm" style="color: #2d2d2d;">${file.filename}</div>
                    <div class="text-xs text-neutral-600 font-medium">
                        ${file.verses_count} verses • ${file.books.join(', ')}
                    </div>
                </div>
            </div>
            <div class="text-xs text-green-600 font-bold">
                <i class="fas fa-check mr-1"></i>
                Uploaded
            </div>
        `;
        
        uploadedFilesList.appendChild(fileElement);
        uploadedFiles.push(file);
        
        // Enable complete button if files uploaded
        if (uploadedFiles.length > 0) {
            completeBtn.disabled = false;
            completeBtn.classList.remove('opacity-50', 'cursor-not-allowed');
        }
    }

    function updateProgress(stats) {
        currentStats = stats;
        
        // Update progress bar
        progressBar.style.width = `${stats.completion_percentage}%`;
        
        // Update text values
        completionPercentage.textContent = `${stats.completion_percentage.toFixed(1)}%`;
        filledVerses.textContent = stats.filled_verses.toLocaleString();
    }

    function completeImport() {
        completeBtn.disabled = true;
        completeBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Completing...';
        completeBtn.classList.add('opacity-50', 'cursor-not-allowed');
        
        fetch(`/project/${projectId}/usfm-complete`, {
            method: 'POST'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showMessage(data.message, 'success');
                
                // Redirect to project page after a short delay
                setTimeout(() => {
                    window.location.href = `/project/${projectId}`;
                }, 2000);
                
            } else {
                showMessage(data.error || 'Completion failed', 'error');
                completeBtn.disabled = false;
                completeBtn.innerHTML = '<i class="fas fa-check mr-2"></i>Complete Import';
                completeBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            }
        })
        .catch(error => {
            console.error('Completion error:', error);
            showMessage('Completion failed: ' + error.message, 'error');
            completeBtn.disabled = false;
            completeBtn.innerHTML = '<i class="fas fa-check mr-2"></i>Complete Import';
            completeBtn.classList.remove('opacity-50', 'cursor-not-allowed');
        });
    }

    function showMessage(message, type) {
        // Create message element
        const messageElement = document.createElement('div');
        messageElement.className = `fixed top-4 right-4 p-4 marker-border-thin z-50 ${
            type === 'success' ? 'paper-light border-green-600 text-green-700' : 'paper-light border-red-600 text-red-700'
        }`;
        messageElement.innerHTML = `
            <div class="flex items-center space-x-2">
                <i class="fas ${type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle'}"></i>
                <span class="font-medium">${message}</span>
            </div>
        `;
        
        document.body.appendChild(messageElement);
        
        // Remove after 5 seconds
        setTimeout(() => {
            messageElement.remove();
        }, 5000);
    }

    // Load existing progress on page load
    fetch(`/project/${projectId}/usfm-status`)
        .then(response => response.json())
        .then(data => {
            if (data.stats) {
                updateProgress(data.stats);
            }
            if (data.uploaded_files && data.uploaded_files.length > 0) {
                data.uploaded_files.forEach(file => {
                    addUploadedFile(file);
                });
            }
        })
        .catch(error => {
            console.error('Error loading status:', error);
        });
</script>
{% endblock %} 