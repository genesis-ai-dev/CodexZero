{% extends "base.html" %}

{% block title %}USFM Import - {{ project.target_language }} Translation - CodexZero{% endblock %}

{% block content %}
<section class="min-h-screen">
    <!-- Clean Header -->
    <div class="max-w-5xl mx-auto px-4 sm:px-6 py-4 sm:py-8">
        <div class="bg-white/80 backdrop-blur-sm rounded-2xl shadow-lg border border-white/20 p-4 sm:p-8 mb-6 sm:mb-8">
            <div class="flex flex-col lg:flex-row lg:items-center justify-between gap-4">
                <div class="min-w-0 flex-1">
                    <div class="flex flex-wrap items-center text-sm text-neutral-600 mb-2 font-medium">
                        <a href="{{ url_for('projects.view_project', project_id=project.id) }}" class="hover:text-neutral-900 transition-colors">
                            <i class="fas fa-arrow-left mr-2"></i>
                            Back to Project
                        </a>
                        <span class="mx-2">→</span>
                        <span class="truncate">USFM Import</span>
                    </div>
                    <h1 class="text-2xl sm:text-3xl font-bold text-neutral-900 mb-2 break-words">USFM Import</h1>
                    <p class="text-neutral-700 font-medium text-base sm:text-lg">{{ project.target_language }} Translation • {{ project.audience }} • {{ project.style }} style</p>
                </div>
            </div>
        </div>



        <!-- Main Content Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 sm:gap-8 mb-6 sm:mb-8">
            <!-- Upload Section -->
            <div class="bg-white/80 backdrop-blur-sm rounded-2xl shadow-lg border border-white/20 p-4 sm:p-8">
                            <div class="flex items-center mb-6">
                <div class="w-10 h-10 sm:w-12 sm:h-12 bg-neutral-100 rounded-xl flex items-center justify-center mr-3 sm:mr-4">
                    <i class="fas fa-upload text-black text-lg"></i>
                </div>
                    <div>
                        <h3 class="text-lg sm:text-xl font-bold text-neutral-900">Add USFM Files</h3>
                        <p class="text-neutral-700 text-sm mt-1 font-medium">Upload USFM/SFM files to build your Bible</p>
                    </div>
                </div>
                
                <div class="space-y-4">
                    <!-- Upload Mode Toggle -->
                    <div class="flex space-x-4 mb-4">
                        <label class="flex items-center cursor-pointer">
                            <input type="radio" name="upload-mode" value="files" class="mr-2 text-black" checked>
                            <span class="text-sm font-medium text-neutral-700">Select Files</span>
                        </label>
                        <label class="flex items-center cursor-pointer">
                            <input type="radio" name="upload-mode" value="folder" class="mr-2 text-black">
                            <span class="text-sm font-medium text-neutral-700">Select Folder</span>
                        </label>
                    </div>

                    <div class="border-2 border-dashed border-neutral-300 rounded-xl p-4 hover:border-neutral-400 transition-colors">
                        <input type="file" 
                               id="usfm-files" 
                               accept=".usfm,.sfm" 
                               multiple 
                               class="block w-full text-sm text-neutral-500 file:mr-4 file:py-2 file:px-4 file:border-0 file:rounded-lg file:bg-neutral-50 file:text-sm file:font-medium file:text-black hover:file:bg-neutral-100">
                    </div>
                    
                    <button id="upload-btn" class="w-full px-6 py-3 bg-black text-white hover:bg-neutral-800 rounded-xl font-semibold shadow-lg">
                        <i class="fas fa-upload mr-2"></i>
                        Upload & Create Translation
                    </button>
                    
                    <div class="text-xs text-neutral-500 text-center font-medium">
                        Supports .usfm and .sfm files • Upload individual files or entire folders
                    </div>
                </div>
            </div>

            <!-- Uploaded Files -->
            <div class="bg-white/80 backdrop-blur-sm rounded-2xl shadow-lg border border-white/20 p-4 sm:p-8">
                <div class="flex items-center mb-6">
                    <div class="w-10 h-10 sm:w-12 sm:h-12 bg-neutral-100 rounded-xl flex items-center justify-center mr-3 sm:mr-4">
                        <i class="fas fa-file-code text-black text-lg"></i>
                    </div>
                    <div>
                        <h3 class="text-lg sm:text-xl font-bold text-neutral-900">Files Added</h3>
                        <p class="text-neutral-700 text-sm mt-1 font-medium">Track your uploaded USFM files</p>
                    </div>
                </div>
                
                <div id="uploaded-files-list" class="space-y-3 max-h-64 overflow-y-auto">
                    <div id="no-files-message" class="text-center py-6 sm:py-8">
                        <div class="w-12 h-12 sm:w-16 sm:h-16 bg-neutral-100 rounded-xl flex items-center justify-center mx-auto mb-4">
                            <i class="fas fa-file-code text-neutral-400 text-lg sm:text-xl"></i>
                        </div>
                        <h4 class="text-base sm:text-lg font-bold mb-2 text-neutral-900">No files uploaded yet</h4>
                        <p class="text-neutral-600 text-sm font-medium">Upload USFM files to get started</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Complete Section -->
        <div class="bg-white/80 backdrop-blur-sm rounded-2xl shadow-lg border border-white/20 p-4 sm:p-8">
            <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-4">
                <div class="flex items-center">
                    <div class="w-10 h-10 sm:w-12 sm:h-12 bg-neutral-100 rounded-xl flex items-center justify-center mr-3 sm:mr-4">
                        <i class="fas fa-check-circle text-black text-lg"></i>
                    </div>
                    <div>
                        <h3 class="text-lg sm:text-xl font-bold text-neutral-900">Create eBible File</h3>
                        <p class="text-neutral-700 text-sm mt-1 font-medium">Complete the import when you have all the books you need</p>
                    </div>
                </div>
                
                <button id="complete-btn" class="w-full sm:w-auto px-6 py-3 bg-black text-white hover:bg-neutral-800 rounded-xl font-semibold shadow-lg opacity-50 cursor-not-allowed" disabled>
                    <i class="fas fa-check mr-2"></i>
                    Complete Import
                </button>
            </div>
        </div>
    </div>
</section>
{% endblock %}

{% block scripts %}
<script>
    const projectId = {{ project.id }};
    let uploadedFiles = [];
    // DOM Elements
    const uploadBtn = document.getElementById('upload-btn');
    const completeBtn = document.getElementById('complete-btn');
    const fileInput = document.getElementById('usfm-files');
    const uploadedFilesList = document.getElementById('uploaded-files-list');
    const noFilesMessage = document.getElementById('no-files-message');
    const uploadModeRadios = document.querySelectorAll('input[name="upload-mode"]');

    // Upload mode toggle handler
    uploadModeRadios.forEach(radio => {
        radio.addEventListener('change', function() {
            if (this.value === 'folder') {
                fileInput.setAttribute('webkitdirectory', '');
                fileInput.removeAttribute('multiple');
                fileInput.removeAttribute('accept');
            } else {
                fileInput.removeAttribute('webkitdirectory');
                fileInput.setAttribute('multiple', '');
                fileInput.setAttribute('accept', '.usfm,.sfm');
            }
            // Clear current selection
            fileInput.value = '';
        });
    });

    // Upload button handler
    uploadBtn.addEventListener('click', function() {
        const files = fileInput.files;
        if (files.length === 0) {
            showMessage('Please select at least one USFM file or folder', 'error');
            return;
        }
        
        // Always filter for USFM/SFM files (regardless of mode)
        const usfmFiles = [];
        const filteredOutFiles = [];
        
        for (let i = 0; i < files.length; i++) {
            const file = files[i];
            const fileName = file.name.toLowerCase();
            
            if (fileName.endsWith('.usfm') || fileName.endsWith('.sfm')) {
                usfmFiles.push(file);
            } else {
                filteredOutFiles.push(file.name);
            }
        }
        
        // Show info about filtered files if any were excluded
        if (filteredOutFiles.length > 0) {
            const truncatedList = filteredOutFiles.slice(0, 3);
            const remaining = filteredOutFiles.length - 3;
            let message = `Filtered out ${filteredOutFiles.length} non-USFM file${filteredOutFiles.length > 1 ? 's' : ''}: ${truncatedList.join(', ')}`;
            if (remaining > 0) {
                message += ` and ${remaining} more`;
            }
            showMessage(message, 'info');
        }
        
        if (usfmFiles.length === 0) {
            showMessage('No USFM or SFM files found in selection', 'error');
            return;
        }
        
        uploadFiles(usfmFiles);
    });

    // Complete button handler
    completeBtn.addEventListener('click', function() {
        if (uploadedFiles.length === 0) {
            showMessage('Please upload at least one USFM file before completing', 'error');
            return;
        }
        
        completeImport();
    });

    function uploadFiles(files) {
        uploadBtn.disabled = true;
        uploadBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Uploading...';
        uploadBtn.classList.add('opacity-50', 'cursor-not-allowed');
        
        const formData = new FormData();
        
        // Add all USFM/SFM files
        for (let i = 0; i < files.length; i++) {
            formData.append('usfm_files', files[i]);
        }
        
        showMessage(`Uploading ${files.length} USFM file${files.length > 1 ? 's' : ''}...`, 'info');
        
        fetch(`/project/${projectId}/usfm-upload`, {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Show success message and redirect
                showMessage(data.message, 'success');
                
                // Redirect to project page after success
                setTimeout(() => {
                    window.location.href = `/project/${projectId}`;
                }, 1500);
                
            } else {
                showMessage(data.error || 'Upload failed', 'error');
            }
        })
        .catch(error => {
            console.error('Upload error:', error);
            showMessage('Upload failed: ' + error.message, 'error');
        })
        .finally(() => {
            uploadBtn.disabled = false;
            uploadBtn.innerHTML = '<i class="fas fa-upload mr-2"></i>Upload & Add to Bible';
            uploadBtn.classList.remove('opacity-50', 'cursor-not-allowed');
        });
    }

    function addUploadedFile(file) {
        // Hide no files message
        if (noFilesMessage) {
            noFilesMessage.remove();
        }
        
        // Create file element
        const fileElement = document.createElement('div');
        fileElement.className = 'bg-white/90 border border-neutral-200 rounded-xl p-4 flex items-center justify-between hover:shadow-md';
        fileElement.innerHTML = `
            <div class="flex items-center min-w-0 flex-1">
                <div class="w-8 h-8 bg-neutral-100 rounded-lg flex items-center justify-center mr-3 flex-shrink-0">
                    <i class="fas fa-file-code text-black text-sm"></i>
                </div>
                <div class="min-w-0 flex-1">
                    <div class="font-medium text-sm text-neutral-900 truncate">${file.filename}</div>
                    <div class="text-xs text-neutral-600 font-medium">${file.verses_count} verses • ${file.books.join(', ')}</div>
                </div>
            </div>
            <div class="text-xs text-black font-bold bg-neutral-100 px-2 py-1 rounded-lg flex-shrink-0">Added</div>
        `;
        
        uploadedFilesList.appendChild(fileElement);
        uploadedFiles.push(file);
        
        // Enable complete button if files uploaded
        if (uploadedFiles.length > 0) {
            completeBtn.disabled = false;
            completeBtn.classList.remove('opacity-50', 'cursor-not-allowed');
        }
    }



    function completeImport() {
        completeBtn.disabled = true;
        completeBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Completing...';
        completeBtn.classList.add('opacity-50', 'cursor-not-allowed');
        
        fetch(`/project/${projectId}/usfm-complete`, {
            method: 'POST'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showMessage(data.message, 'success');
                
                // Redirect to project page after a short delay
                setTimeout(() => {
                    window.location.href = `/project/${projectId}`;
                }, 2000);
                
            } else {
                showMessage(data.error || 'Completion failed', 'error');
                completeBtn.disabled = false;
                completeBtn.innerHTML = '<i class="fas fa-check mr-2"></i>Complete Import';
                completeBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            }
        })
        .catch(error => {
            console.error('Completion error:', error);
            showMessage('Completion failed: ' + error.message, 'error');
            completeBtn.disabled = false;
            completeBtn.innerHTML = '<i class="fas fa-check mr-2"></i>Complete Import';
            completeBtn.classList.remove('opacity-50', 'cursor-not-allowed');
        });
    }

    function showMessage(message, type) {
        // Create message element
        const messageElement = document.createElement('div');
        const styles = {
            success: 'bg-green-50 border-green-200 text-green-800',
            error: 'bg-red-50 border-red-200 text-red-800',
            info: 'bg-blue-50 border-blue-200 text-blue-800'
        };
        const icons = {
            success: 'fa-check-circle',
            error: 'fa-exclamation-circle',
            info: 'fa-info-circle'
        };
        
        messageElement.className = `fixed top-4 right-4 p-4 rounded-xl shadow-lg border z-50 max-w-sm ${styles[type] || styles.info}`;
        messageElement.innerHTML = `
            <div class="flex items-center space-x-2">
                <i class="fas ${icons[type] || icons.info} flex-shrink-0"></i>
                <span class="font-medium text-sm">${message}</span>
            </div>
        `;
        
        document.body.appendChild(messageElement);
        
        // Remove after 5 seconds
        setTimeout(() => {
            messageElement.remove();
        }, 5000);
    }

    // Page ready
</script>
{% endblock %} 