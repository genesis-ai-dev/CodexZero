{% macro verse_cell() %}
<script>
class VerseCell {
    constructor(element) {
        this.element = element;
        this.textarea = element.querySelector('textarea');
        this.audioControls = element.querySelector('.audio-controls');
        this.currentAudio = null;
        this.setupEventListeners();
        this.setupAudioControls();
    }
    
    setupEventListeners() {
        if (!this.textarea) return;
        
        this.textarea.addEventListener('focus', () => {
            this.expand();
        });
        
        this.textarea.addEventListener('blur', () => {
            setTimeout(() => {
                if (!this.element.contains(document.activeElement)) {
                    this.contract();
                }
            }, 150);
        });
        
        this.textarea.addEventListener('input', () => {
            this.autoResize();
        });
        
        this.element.addEventListener('mousedown', (e) => {
            if (e.target.closest('.audio-controls')) {
                e.preventDefault();
            }
        });
    }
    
    setupAudioControls() {
        if (!this.audioControls) return;
        
        const playBtn = this.audioControls.querySelector('.play-audio-btn');
        const pauseBtn = this.audioControls.querySelector('.pause-audio-btn');
        const ttsBtn = this.audioControls.querySelector('.tts-btn');
        const tuningBtn = this.audioControls.querySelector('.audio-tuning-btn');
        const voiceSelect = this.audioControls.querySelector('.voice-selector');
        
        // Set default voice from localStorage
        if (voiceSelect) {
            const savedVoice = localStorage.getItem('preferredVoice') || 'onyx';
            voiceSelect.value = savedVoice;
            
            // Save voice preference when changed and sync all dropdowns
            voiceSelect.addEventListener('change', () => {
                const selectedVoice = voiceSelect.value;
                localStorage.setItem('preferredVoice', selectedVoice);
                
                // Update all other voice selectors on the page
                document.querySelectorAll('.voice-selector').forEach(selector => {
                    if (selector !== voiceSelect) {
                        selector.value = selectedVoice;
                    }
                });
            });
        }
        
        if (ttsBtn) {
            ttsBtn.addEventListener('click', () => {
                this.generateTTS();
            });
        }
        
        if (playBtn) {
            playBtn.addEventListener('click', () => {
                this.playAudio();
            });
        }
        
        if (pauseBtn) {
            pauseBtn.addEventListener('click', () => {
                this.pauseAudio();
            });
        }
        
        if (tuningBtn) {
            tuningBtn.addEventListener('click', () => {
                this.openAudioTuningModal();
            });
        }
    }
    
        async generateTTS() {
        const text = this.textarea.value.trim();
        if (!text) return;

        const ttsBtn = this.audioControls.querySelector('.tts-btn');
        const voiceSelect = this.audioControls.querySelector('.voice-selector');
        const voice = voiceSelect?.value || 'onyx';
        
        const verseIndex = this.textarea.dataset.verseIndex;
        const textId = this.textarea.dataset.textId || 'default';
        const projectId = window.projectId || this.textarea.dataset.projectId;

        ttsBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
        ttsBtn.disabled = true;
        
        const response = await fetch(`/project/${projectId}/verse-audio/${textId}/${verseIndex}/tts`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ text, voice })
        });
        
        const data = await response.json();
        
        this.updateAudioControls(true);
        this.playAudio();
        
        ttsBtn.innerHTML = '<i class="fas fa-microphone"></i>';
        ttsBtn.disabled = false;
    }
    
    async playAudio() {
        const verseIndex = this.textarea.dataset.verseIndex;
        const textId = this.textarea.dataset.textId || 'default';
        const projectId = window.projectId || this.textarea.dataset.projectId;
        
        if (this.currentAudio && !this.currentAudio.paused) {
            this.pauseAudio();
            return;
        }
        
        try {
            const checkResponse = await fetch(`/project/${projectId}/verse-audio/${textId}/${verseIndex}/check`);
            const checkData = await checkResponse.json();
            
            if (checkData.exists) {
                this.currentAudio = new Audio(`/project/${projectId}/verse-audio/${checkData.audio_id}/download`);
                this.currentAudio.play();
                
                this.updatePlaybackControls(true);
                
                this.currentAudio.onended = () => {
                    this.updatePlaybackControls(false);
                    this.currentAudio = null;
                };
                
                this.currentAudio.onerror = () => {
                    this.updatePlaybackControls(false);
                    this.currentAudio = null;
                    alert('Failed to play audio');
                };
            } else {
                alert('No audio available. Generate TTS first.');
            }
        } catch (error) {
            console.error('Error playing audio:', error);
            alert('Failed to play audio');
        }
    }
    
    async deleteAudio() {
        const verseIndex = this.textarea.dataset.verseIndex;
        const textId = this.textarea.dataset.textId || 'default';
        const projectId = window.projectId || this.textarea.dataset.projectId;
        
        if (!confirm('Delete audio for this verse?')) return;
        
        try {
            const checkResponse = await fetch(`/project/${projectId}/verse-audio/${textId}/${verseIndex}/check`);
            const checkData = await checkResponse.json();
            
            if (checkData.exists) {
                const deleteResponse = await fetch(`/project/${projectId}/verse-audio/${checkData.audio_id}`, {
                    method: 'DELETE'
                });
                
                if (deleteResponse.ok) {
                    this.updateAudioControls(false);
                } else {
                    alert('Failed to delete audio');
                }
            }
        } catch (error) {
            console.error('Error deleting audio:', error);
            alert('Failed to delete audio');
        }
    }
    
    pauseAudio() {
        if (this.currentAudio && !this.currentAudio.paused) {
            this.currentAudio.pause();
            this.updatePlaybackControls(false);
        }
    }
    
    openAudioTuningModal() {
        const originalText = this.textarea.value.trim();
        if (!originalText) return;
        
        window.AudioTuningModal?.open({
            projectId: window.projectId || this.textarea.dataset.projectId,
            textId: this.textarea.dataset.textId || 'default',
            verseIndex: this.textarea.dataset.verseIndex,
            originalText,
            onApply: (audioId) => {
                if (audioId) {
                    this.updateAudioControls(true);
                    setTimeout(() => this.playAudio(), 300);
                } else {
                    this.updateAudioControls(false);
                }
            }
        });
    }
    
    updateAudioControls(hasAudio) {
        const playBtn = this.audioControls.querySelector('.play-audio-btn');
        const pauseBtn = this.audioControls.querySelector('.pause-audio-btn');
        const tuningBtn = this.audioControls.querySelector('.audio-tuning-btn');
        
        if (playBtn) {
            playBtn.style.display = hasAudio ? 'flex' : 'none';
        }
        if (pauseBtn) {
            pauseBtn.style.display = 'none';
        }
        if (tuningBtn) {
            tuningBtn.style.display = hasAudio ? 'flex' : 'none';
        }
    }
    
    updatePlaybackControls(isPlaying) {
        const playBtn = this.audioControls.querySelector('.play-audio-btn');
        const pauseBtn = this.audioControls.querySelector('.pause-audio-btn');
        
        if (playBtn) {
            playBtn.style.display = isPlaying ? 'none' : 'flex';
        }
        if (pauseBtn) {
            pauseBtn.style.display = isPlaying ? 'flex' : 'none';
        }
    }
    
    expand() {
        this.element.classList.add('expanded');
        this.autoResize();
        
        const rect = this.element.getBoundingClientRect();
        const viewportHeight = window.innerHeight;
        
        if (rect.top < 100 || rect.bottom > viewportHeight - 100) {
            this.element.scrollIntoView({
                behavior: 'smooth',
                block: 'center'
            });
        }
    }
    
    contract() {
        this.element.classList.remove('expanded');
        this.autoResize();
    }
    
    autoResize() {
        if (!this.textarea) return;
        
        this.textarea.style.height = 'auto';
        
        const minHeight = this.element.classList.contains('expanded') ? 120 : 60;
        const maxHeight = 300;
        const scrollHeight = this.textarea.scrollHeight;
        
        const newHeight = Math.max(minHeight, Math.min(maxHeight, scrollHeight));
        this.textarea.style.height = newHeight + 'px';
    }
    
    async checkAudioStatus() {
        const verseIndex = this.textarea.dataset.verseIndex;
        const textId = this.textarea.dataset.textId || 'default';
        const projectId = window.projectId || this.textarea.dataset.projectId;
        
        if (!projectId || !verseIndex) return;
        
        try {
            const response = await fetch(`/project/${projectId}/verse-audio/${textId}/${verseIndex}/check`);
            const data = await response.json();
            this.updateAudioControls(data.exists);
        } catch (error) {
            console.error('Error checking audio status:', error);
        }
    }
    
    static initializeAll() {
        document.querySelectorAll('[data-verse-cell]').forEach(element => {
            if (!element._verseCell) {
                element._verseCell = new VerseCell(element);
                element._verseCell.checkAudioStatus();
            }
        });
    }
    
    static initialize(element) {
        if (!element._verseCell) {
            element._verseCell = new VerseCell(element);
            element._verseCell.checkAudioStatus();
        }
        return element._verseCell;
    }
}

document.addEventListener('DOMContentLoaded', () => {
    VerseCell.initializeAll();
});

window.VerseCell = VerseCell;
</script>

<template id="verse-cell-template">
    <div class="verse-cell group" data-verse-cell>
        <div class="verse-cell-header">
            <span class="verse-number">Verse {number}</span>
            <div class="audio-controls absolute top-2 left-2 opacity-0 group-hover:opacity-100 transition-all duration-200 flex items-center gap-1 z-50">
                <select class="voice-selector text-xs px-2 py-1 border border-gray-300 bg-gray-100 text-gray-500 rounded-sm cursor-pointer hover:bg-gray-200 hover:text-gray-700 transition-all focus:outline-none" style="z-index: 9999; position: relative;">
                    <option value="alloy">Alloy</option>
                    <option value="ash">Ash</option>
                    <option value="ballad">Ballad</option>
                    <option value="coral">Coral</option>
                    <option value="echo">Echo</option>
                    <option value="fable">Fable</option>
                    <option value="nova">Nova</option>
                    <option value="onyx" selected>Onyx</option>
                    <option value="sage">Sage</option>
                    <option value="shimmer">Shimmer</option>
                </select>
                <button class="tts-btn w-6 h-6 flex items-center justify-center bg-gray-100 text-gray-500 rounded-sm hover:bg-gray-200 hover:text-gray-700 transition-all focus:outline-none" title="Generate audio">
                    <i class="fas fa-microphone" style="font-size: 10px;"></i>
                </button>
                <button class="play-audio-btn w-6 h-6 flex items-center justify-center bg-gray-100 text-gray-500 rounded-sm hover:bg-gray-200 hover:text-gray-700 transition-all focus:outline-none" title="Play audio" style="display: none;">
                    <i class="fas fa-play" style="font-size: 10px;"></i>
                </button>
                <button class="pause-audio-btn w-6 h-6 flex items-center justify-center bg-gray-100 text-gray-500 rounded-sm hover:bg-gray-200 hover:text-gray-700 transition-all focus:outline-none" title="Pause audio" style="display: none;">
                    <i class="fas fa-pause" style="font-size: 10px;"></i>
                </button>
                <button class="audio-tuning-btn w-6 h-6 flex items-center justify-center bg-gray-100 text-gray-500 rounded-sm hover:bg-blue-100 hover:text-blue-600 transition-all focus:outline-none" title="Audio settings" style="display: none;">
                    <i class="fas fa-sliders-h" style="font-size: 10px;"></i>
                </button>
            </div>
        </div>
        <div class="verse-cell-content">
            <textarea placeholder="Enter verse translation..."></textarea>
        </div>
    </div>
</template>
{% endmacro %} 