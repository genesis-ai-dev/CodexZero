{% macro file_importer(context="create", project=None, upload_endpoint=None, show_back_translation=true, show_usfm=true) %}
<div class="file-importer" data-context="{{ context }}">
    <div class="text-center mb-8">
        <h3 class="text-2xl font-semibold text-neutral-900 mb-2">
            {% if context == "create" %}Choose Your Training Data Source{% elif context == "edit" %}Manage Training Data{% else %}Upload Files{% endif %}
        </h3>
        <p class="text-neutral-600">
            {% if context == "create" %}Select how you'd like to provide training data for your translation project{% elif context == "edit" %}View existing files and add new training data{% else %}Upload source text, target text, or back translation files{% endif %}
        </p>
    </div>

    {% if context == "edit" and project and project.files %}
    <!-- Existing Files (Edit Mode Only) -->
    <div class="mb-8">
        <h4 class="font-semibold text-neutral-900 mb-6">Current Files</h4>
        <div class="space-y-3">
            {% for file in project.files %}
            <div class="flex items-center justify-between py-3 px-4 border border-neutral-200 rounded-lg group hover:bg-neutral-50 transition-colors">
                <div class="flex items-center space-x-3">
                    <i class="fas {% if file.file_type == 'ebible' %}fa-book text-blue-600{% elif file.file_type == 'text' %}fa-file-alt text-green-600{% elif file.file_type == 'back_translation' %}fa-exchange-alt text-orange-600{% elif file.file_type == 'training_data' %}fa-brain text-purple-600{% elif file.file_type == 'usfm' %}fa-code text-purple-600{% elif file.file_type == 'usfm_ebible' %}fa-book-open text-purple-600{% else %}fa-file text-neutral-400{% endif %}"></i>
                    <div>
                        <div class="font-medium text-sm text-neutral-900">{{ file.original_filename }}</div>
                        <div class="text-xs text-neutral-500">
                            {{ file.file_type | title }}
                            {% if file.file_type == 'ebible' %} (eBible Format)
                            {% elif file.file_type == 'text' %} (Plain Text)
                            {% elif file.file_type == 'back_translation' %} (Back Translation)
                            {% elif file.file_type == 'training_data' %} (Fine-tuning Training Data)
                            {% elif file.file_type == 'usfm' %} (USFM Format)
                            {% elif file.file_type == 'usfm_ebible' %} (eBible from USFM)
                            {% endif %}
                            • {{ (file.file_size / 1024) | round(1) }} KB
                            {% if context == "dashboard" %} • Uploaded {{ file.created_at.strftime('%b %d, %Y') }}{% endif %}
                            {% if file.file_type == 'back_translation' and file.paired_with %}
                            <br><span class="text-amber-600"><i class="fas fa-link mr-1"></i>Paired with {{ file.paired_with.original_filename }}</span>
                            {% elif file.file_type == 'training_data' %}
                            <br><span class="text-purple-600"><i class="fas fa-info-circle mr-1"></i>{{ file.line_count }} training examples</span>
                            {% endif %}
                        </div>
                    </div>
                </div>
                <div class="flex items-center space-x-2 opacity-0 group-hover:opacity-100 transition-opacity">
                    {% if context == "dashboard" %}
                    <a href="{{ url_for('serve_upload', filename=file.storage_path) }}" 
                       class="text-xs text-blue-600 hover:text-blue-800 transition-colors" 
                       download="{{ file.original_filename }}">
                        <i class="fas fa-download mr-1"></i>
                        Download
                    </a>
                    {% endif %}
                    <button type="button" onclick="deleteFile({{ file.id }})" class="text-red-600 hover:text-red-800 text-sm px-2 py-1 hover:bg-red-50 rounded-sm transition-all duration-200">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <!-- File Import Options -->
    <div class="flex justify-center">
        <!-- Single Import Text File Option -->
        <div class="file-option available group cursor-pointer hover:bg-neutral-50 py-8 px-6 rounded-lg border-2 border-dashed border-neutral-200 hover:border-neutral-300 transition-all duration-200 max-w-md w-full" data-option="import">
            <div class="text-center">
                <div class="flex justify-center mb-4">
                    <div class="w-12 h-12 bg-blue-50 group-hover:bg-blue-100 rounded-lg flex items-center justify-center transition-colors duration-200">
                        <i class="fas fa-file-import text-blue-600 text-xl"></i>
                    </div>
                </div>
                <h4 class="font-semibold text-neutral-900 mb-2">
                    {% if context == "edit" %}Import Text File{% else %}Import Text File{% endif %}
                </h4>
                <p class="text-sm text-neutral-600 mb-3 leading-relaxed">
                    Upload a text file and designate its type: eBible, plain text, or back translation
                </p>
                <div class="text-xs text-blue-600 font-medium">✓ Available</div>
            </div>
        </div>
    </div>

    {% if show_usfm %}
    <!-- USFM Import Option -->
    <div class="mt-8 flex justify-center">
        <a href="{{ url_for('usfm_import', project_id=project.id) if project else '#' }}" 
           class="file-option available group cursor-pointer hover:bg-neutral-50 py-8 px-6 rounded-lg border-2 border-dashed border-purple-200 hover:border-purple-300 transition-all duration-200 max-w-md w-full block">
            <div class="text-center">
                <div class="flex justify-center mb-4">
                    <div class="w-12 h-12 bg-purple-50 group-hover:bg-purple-100 rounded-lg flex items-center justify-center transition-colors duration-200">
                        <i class="fas fa-code text-purple-600 text-xl"></i>
                    </div>
                </div>
                <h4 class="font-semibold text-neutral-900 mb-2">USFM Import</h4>
                <p class="text-sm text-neutral-600 mb-3 leading-relaxed">
                    Upload USFM files to convert to eBible format. Advanced import with progress tracking.
                </p>
                <div class="text-xs text-green-600 font-medium">✓ Available</div>
            </div>
        </a>
    </div>
    {% endif %}

    <!-- File Upload Details -->
    <div id="upload-details" class="hidden mt-8 p-6 bg-neutral-50 rounded-lg">
        <!-- File Import -->
        <div id="import-upload" class="upload-detail hidden">
            <h4 class="font-semibold text-neutral-900 mb-4">Import Text File</h4>
            <div class="space-y-6">
                <!-- Upload Method Selection -->
                <div class="space-y-3">
                    <label class="flex items-center p-3 border border-neutral-200 rounded-lg hover:bg-neutral-50 cursor-pointer transition-colors">
                        <input type="radio" name="upload_method" value="file" class="mr-3 text-blue-600 focus:ring-blue-500" checked>
                        <div>
                            <div class="font-medium text-neutral-900">Upload File</div>
                            <div class="text-xs text-neutral-500">Upload a .txt file</div>
                        </div>
                    </label>
                    <label class="flex items-center p-3 border border-neutral-200 rounded-lg hover:bg-neutral-50 cursor-pointer transition-colors">
                        <input type="radio" name="upload_method" value="text" class="mr-3 text-blue-600 focus:ring-blue-500">
                        <div>
                            <div class="font-medium text-neutral-900">Paste Text</div>
                            <div class="text-xs text-neutral-500">Paste text directly into a text area</div>
                        </div>
                    </label>
                </div>
                
                <!-- File Upload Section -->
                <div id="file-upload-section">
                    <input type="file" name="text_file" accept=".txt" class="block w-full text-sm text-neutral-500 file:mr-4 file:py-2 file:px-4 file:rounded-sm file:border-0 file:text-sm file:font-semibold file:bg-neutral-900 file:text-white hover:file:bg-neutral-800 transition-colors">
                </div>
                
                <!-- Text Paste Section -->
                <div id="text-paste-section" class="hidden">
                    <textarea name="text_content" rows="8" maxlength="16000" class="w-full p-4 border border-neutral-200 rounded-lg focus:ring-2 focus:ring-neutral-900 focus:border-transparent resize-none" placeholder="Paste your text here..."></textarea>
                    <div class="flex justify-between items-center mt-2">
                        <p class="text-sm text-neutral-600">Maximum 16,000 characters (~2000 words)</p>
                        <span id="char-count" class="text-sm text-neutral-500">0 / 16,000</span>
                    </div>
                </div>

                <!-- File Type Designation -->
                <div class="border-t border-neutral-200 pt-6">
                    <h5 class="font-medium text-neutral-900 mb-3">Designate File Type</h5>
                    <div class="space-y-3">
                        <label class="flex items-start p-3 border border-neutral-200 rounded-lg hover:bg-neutral-50 cursor-pointer transition-colors">
                            <input type="radio" name="file_type" value="ebible" class="mr-3 text-blue-600 focus:ring-blue-500 mt-0.5" checked>
                            <div>
                                <div class="font-medium text-neutral-900">eBible Format</div>
                                <div class="text-xs text-neutral-500">Bible text in eBible format</div>
                            </div>
                        </label>
                        <label class="flex items-start p-3 border border-neutral-200 rounded-lg hover:bg-neutral-50 cursor-pointer transition-colors">
                            <input type="radio" name="file_type" value="text" class="mr-3 text-blue-600 focus:ring-blue-500 mt-0.5">
                            <div>
                                <div class="font-medium text-neutral-900">Plain Text</div>
                                <div class="text-xs text-neutral-500">General text content for training or reference</div>
                            </div>
                        </label>
                        {% if show_back_translation %}
                        <label class="flex items-start p-3 border border-neutral-200 rounded-lg hover:bg-neutral-50 cursor-pointer transition-colors">
                            <input type="radio" name="file_type" value="back_translation" class="mr-3 text-blue-600 focus:ring-blue-500 mt-0.5">
                            <div>
                                <div class="font-medium text-neutral-900">Back Translation</div>
                                <div class="text-xs text-neutral-500">Back translation that needs to be paired with a forward translation</div>
                            </div>
                        </label>
                        {% endif %}
                    </div>
                </div>

                <!-- Pairing Section (for back translations) -->
                {% if show_back_translation %}
                <div id="pairing-section" class="hidden border-t border-neutral-200 pt-6">
                    <h5 class="font-medium text-neutral-900 mb-3">Pair with Forward Translation</h5>
                    <div class="space-y-3">
                        {% if project and project.files %}
                        {% for file in project.files %}
                        {% if file.file_type in ['ebible', 'text'] %}
                        <label class="flex items-center p-3 border border-neutral-200 rounded-lg hover:bg-neutral-50 cursor-pointer transition-colors">
                            <input type="radio" name="paired_with_id" value="{{ file.id }}" class="mr-3 text-blue-600 focus:ring-blue-500">
                            <div class="flex-grow">
                                <div class="font-medium text-neutral-900">{{ file.original_filename }}</div>
                                <div class="text-xs text-neutral-500">{{ file.file_type | title }} • {{ (file.file_size / 1024) | round(1) }} KB</div>
                            </div>
                        </label>
                        {% endif %}
                        {% endfor %}
                        {% else %}
                        <div class="p-3 bg-amber-50 border border-amber-200 rounded-lg">
                            <div class="flex items-start space-x-2">
                                <i class="fas fa-info-circle text-amber-600 mt-0.5"></i>
                                <div class="text-sm text-amber-700">
                                    You need to upload a forward translation first before you can add a back translation.
                                </div>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endif %}
            </div>
        </div>


        
        <!-- Upload Button (Dashboard Context) -->
        {% if context == "dashboard" %}
        <div class="mt-4 flex justify-end">
            <button type="button" id="upload-file-btn" class="hidden px-6 py-2 bg-neutral-900 text-white rounded-sm hover:bg-neutral-800 transition-colors">
                <i class="fas fa-upload mr-2"></i>
                Upload File
            </button>
        </div>
        {% endif %}
    </div>
</div>

<script>
// File importer functionality
document.addEventListener('DOMContentLoaded', function() {
    const fileOptions = document.querySelectorAll('.file-option.available');
    const uploadDetails = document.getElementById('upload-details');
    const uploadSections = document.querySelectorAll('.upload-detail');
    const uploadMethodRadios = document.querySelectorAll('input[name="upload_method"]');
    const fileUploadSection = document.getElementById('file-upload-section');
    const textPasteSection = document.getElementById('text-paste-section');
    const charCount = document.getElementById('char-count');
    const targetTextArea = document.querySelector('textarea[name="text_content"]');
    const uploadBtn = document.getElementById('upload-file-btn');
    const fileTypeRadios = document.querySelectorAll('input[name="file_type"]');
    const pairingSection = document.getElementById('pairing-section');
    
    const projectId = window.location.pathname.split('/')[2];
    const context = document.querySelector('.file-importer')?.dataset.context;

    // Handle file option selection (import and USFM options)
    fileOptions.forEach(option => {
        option.addEventListener('click', function() {
            // Remove active state from all options
            fileOptions.forEach(opt => opt.classList.remove('bg-neutral-100', 'border-neutral-300'));
            
            // Add active state to clicked option
            this.classList.add('bg-neutral-100', 'border-neutral-300');
            
            // Show upload details
            uploadDetails.classList.remove('hidden');
            
            // Hide all upload sections
            uploadSections.forEach(section => section.classList.add('hidden'));
            
            // Show import upload section
            const importSection = document.getElementById('import-upload');
            if (importSection) {
                importSection.classList.remove('hidden');
            }
            
            // Show upload button for dashboard context
            if (context === 'dashboard' && uploadBtn) {
                uploadBtn.classList.remove('hidden');
            }
        });
    });

    // Handle upload method change for target text
    if (uploadMethodRadios.length > 0) {
        uploadMethodRadios.forEach(radio => {
            radio.addEventListener('change', function() {
                if (this.value === 'file') {
                    fileUploadSection.classList.remove('hidden');
                    textPasteSection.classList.add('hidden');
                } else {
                    fileUploadSection.classList.add('hidden');
                    textPasteSection.classList.remove('hidden');
                }
            });
        });
    }

    // Handle file type change (show/hide pairing section)
    if (fileTypeRadios.length > 0) {
        fileTypeRadios.forEach(radio => {
            radio.addEventListener('change', function() {
                if (pairingSection) {
                    if (this.value === 'back_translation') {
                        pairingSection.classList.remove('hidden');
                    } else {
                        pairingSection.classList.add('hidden');
                    }
                }
            });
        });
    }

    // Character counter for text area
    if (targetTextArea && charCount) {
        targetTextArea.addEventListener('input', function() {
            const count = this.value.length;
            charCount.textContent = `${count} / 16,000`;
            
            if (count > 16000) {
                charCount.classList.add('text-red-600');
            } else {
                charCount.classList.remove('text-red-600');
            }
        });
    }
    
    // Handle upload button click (dashboard context)
    if (uploadBtn && context === 'dashboard') {
        uploadBtn.addEventListener('click', function() {
            uploadFile();
        });
    }
    
    // Upload file function
    function uploadFile() {
        uploadBtn.disabled = true;
        uploadBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Uploading...';
        
        const formData = new FormData();
        
        // Handle regular text file upload
        const fileType = document.querySelector('input[name="file_type"]:checked')?.value;
        if (!fileType) {
            alert('Please select a file type');
            resetUploadBtn();
            return;
        }
        formData.append('file_type', fileType);
        
        // Get upload method
        const uploadMethod = document.querySelector('input[name="upload_method"]:checked').value;
        formData.append('upload_method', uploadMethod);
        
        // Handle file or text content
        if (uploadMethod === 'file') {
            const fileInput = document.querySelector('input[name="text_file"]');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('Please select a file');
                resetUploadBtn();
                return;
            }
            
            formData.append('text_file', file);
        } else {
            const textContent = document.querySelector('textarea[name="text_content"]').value.trim();
            
            if (!textContent) {
                alert('Please enter some text');
                resetUploadBtn();
                return;
            }
            
            if (textContent.length > 16000) {
                alert('Text content exceeds 16,000 character limit');
                resetUploadBtn();
                return;
            }
            
            formData.append('text_content', textContent);
        }
        
        // Handle pairing for back translations
        if (fileType === 'back_translation') {
            const pairedWithId = document.querySelector('input[name="paired_with_id"]:checked')?.value;
            if (!pairedWithId) {
                alert('Please select a forward translation to pair with this back translation');
                resetUploadBtn();
                return;
            }
            formData.append('paired_with_id', pairedWithId);
        }
        
        formData.append('upload_type', 'regular');
        
        fetch(`/project/${projectId}/upload-file`, {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(data.message);
                location.reload(); // Refresh to show new file
            } else {
                alert(data.error || 'Upload failed');
            }
        })
        .catch(error => {
            console.error('Upload error:', error);
            alert('Upload failed: ' + error.message);
        })
        .finally(() => {
            resetUploadBtn();
        });
    }
    
    function resetUploadBtn() {
        uploadBtn.disabled = false;
        uploadBtn.innerHTML = '<i class="fas fa-upload mr-2"></i>Upload File';
    }
});

// Delete file function (for edit mode)
function deleteFile(fileId) {
    if (!confirm('Are you sure you want to delete this file?')) return;
    
    const projectId = window.location.pathname.split('/')[2];
    
    fetch(`/project/${projectId}/files/${fileId}`, {
        method: 'DELETE',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => {
        if (response.ok) {
            location.reload();
        } else {
            alert('Error deleting file. Please try again.');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error deleting file. Please try again.');
    });
}
</script>
{% endmacro %} 