{% macro audio_tuning_modal() %}
<div id="audio-tuning-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white rounded-2xl shadow-2xl max-w-lg w-full max-h-[70vh] flex flex-col border border-neutral-200">
            <div class="flex items-center justify-between p-6 border-b border-neutral-200">
                <h3 class="text-xl font-bold text-neutral-900 tracking-tight">Fine-tune Audio</h3>
                <button onclick="closeModal()" class="text-neutral-400 hover:text-neutral-600 p-2 rounded-lg hover:bg-neutral-100 transition-all duration-200">
                    <i class="fas fa-times text-lg"></i>
                </button>
            </div>
            
            <!-- Voice Profile Section -->
            <div class="p-4 bg-blue-50 border-b border-blue-200">
                <label class="text-base font-semibold text-blue-900 mb-2 block">Voice Profile</label>
                <textarea 
                    id="voice-profile-input" 
                    placeholder="Describe voice characteristics (e.g., 'warm, authoritative tone with slight British accent, speak slowly')"
                    class="w-full border border-blue-300 rounded-lg px-3 py-2 text-sm bg-white focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-200 resize-none shadow-sm"
                    rows="3"
                    maxlength="500"
                ></textarea>
                <div class="flex justify-between items-center mt-1">
                    <span class="text-xs text-blue-600 font-medium">Auto-saves when generating audio</span>
                    <span class="text-xs text-blue-600 profile-char-counter font-mono">0/500</span>
                </div>
            </div>
            

            
            <!-- Iterations list -->
            <div class="flex-1 overflow-y-auto p-4 space-y-3" id="iterations-list">
                <!-- Iterations will be added here -->
            </div>
            
            <!-- Generate button -->
            <div class="border-t border-neutral-200 p-4">
                <button onclick="generateIteration()" id="generate-btn" class="w-full px-4 py-3 bg-gradient-to-r from-blue-600 to-blue-700 text-white rounded-lg hover:from-blue-700 hover:to-blue-800 transition-all duration-200 font-semibold shadow-lg hover:shadow-xl">
                    <i class="fas fa-volume-up mr-2"></i>Generate & Play Audio
                </button>
                <div class="text-xs text-gray-500 text-center mt-2">Uses voice profile above â€¢ Auto-saves on generate</div>
            </div>
            
            <!-- Footer -->
            <div class="flex justify-between items-center p-4 border-t border-neutral-200 bg-neutral-50 rounded-b-2xl">
                <button onclick="deleteAllAudio()" class="px-4 py-2 text-red-600 hover:bg-red-50 rounded-lg font-medium hover:text-red-700 transition-all duration-200 text-sm">
                    <i class="fas fa-trash mr-1"></i>Delete All
                </button>
                <div class="flex space-x-2">
                    <button onclick="closeModal()" class="px-4 py-2 border border-neutral-200 rounded-lg text-neutral-600 hover:text-neutral-900 hover:bg-neutral-100 transition-all duration-200 font-medium text-sm">
                        Close
                    </button>
                    <button onclick="applySelected()" id="apply-btn" class="px-6 py-2 bg-gradient-to-r from-green-600 to-green-700 text-white rounded-lg hover:from-green-700 hover:to-green-800 transition-all duration-200 font-semibold shadow-lg text-sm" disabled>
                        Apply Selected
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let modalData = null;
let iterations = [];
let selectedIndex = null;

window.AudioTuningModal = {
    open: function(data) {
        modalData = data;
        iterations = [];
        selectedIndex = null;
        
        // Original text display removed
        // Voice is fixed to onyx
        document.getElementById('iterations-list').innerHTML = '';
        document.getElementById('audio-tuning-modal').classList.remove('hidden');
        
        loadVoiceProfile();
        loadCurrentAudio();
        updateApplyButton();
        setupVoiceProfileListeners();
    }
};

function closeModal() {
    document.getElementById('audio-tuning-modal').classList.add('hidden');
    modalData = null;
    iterations = [];
    selectedIndex = null;
}

async function loadCurrentAudio() {
    try {
        const response = await fetch(`/project/${modalData.projectId}/verse-audio/${modalData.textId}/${modalData.verseIndex}/check`);
        const data = await response.json();
        
        if (data.exists) {
            addIteration({
                audioId: data.audio_id,
                prompt: 'Current audio',
                voice: 'current',
                isCurrent: true
            });
            selectIteration(0);
        }
    } catch (error) {
        console.error('Error loading current audio:', error);
    }
}

async function generateIteration() {
    const voiceProfile = document.getElementById('voice-profile-input').value.trim();
    const btn = document.getElementById('generate-btn');
    
    if (!voiceProfile.trim()) {
        alert('Please enter voice profile description');
        return;
    }
    
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Generating...';
    
    try {
        // Auto-save voice profile first
        await saveVoiceProfile(false); // false = don't show feedback
        
        const response = await fetch(`/project/${modalData.projectId}/verse-audio/${modalData.textId}/${modalData.verseIndex}/tts-iterate`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                text: modalData.originalText,
                voice: 'onyx',
                instructions: voiceProfile
            })
        });
        
        const data = await response.json();
        
        const newIteration = {
            audioId: data.audio_id,
            prompt: voiceProfile,
            voice: 'onyx',
            isCurrent: false
        };
        
        addIteration(newIteration);
        selectIteration(iterations.length - 1);
        
        // Auto-play the new iteration
        setTimeout(() => {
            const playButton = document.querySelector(`[onclick*="${data.audio_id}"]`);
            if (playButton) {
                playAudio(data.audio_id, playButton);
            }
        }, 500);
        
    } catch (error) {
        console.error('Error generating audio:', error);
        alert('Failed to generate audio');
    } finally {
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-volume-up mr-2"></i>Generate & Play Audio';
    }
}

function addIteration(iteration) {
    iterations.push(iteration);
    const index = iterations.length - 1;
    
    const div = document.createElement('div');
    div.className = 'iteration border rounded-lg p-3 cursor-pointer hover:bg-gray-50 transition-all duration-200';
    div.dataset.index = index;
    div.onclick = () => selectIteration(index);
    
    div.innerHTML = `
        <div class="flex items-start justify-between mb-2">
            <div class="flex items-center space-x-2">
                <div class="w-2 h-2 rounded-full ${iteration.isCurrent ? 'bg-green-500' : 'bg-blue-500'}"></div>
                <span class="text-sm font-medium">${iteration.isCurrent ? 'Current' : 'Onyx'}</span>
                ${iteration.isCurrent ? '<span class="text-xs bg-green-100 text-green-800 px-2 py-1 rounded">Original</span>' : ''}
            </div>
            <span class="text-xs text-gray-500">${new Date().toLocaleTimeString()}</span>
        </div>
        <div class="text-sm text-gray-700 mb-2" style="display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;">${iteration.prompt}</div>
        
        <div class="bg-gray-50 rounded p-3">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-2">
                    <button onclick="playAudio('${iteration.audioId}', this)" class="w-8 h-8 bg-blue-500 text-white rounded-full hover:bg-blue-600 flex items-center justify-center">
                        <i class="fas fa-play text-xs"></i>
                    </button>
                    <span class="text-xs text-gray-600">${iteration.isCurrent ? 'Current Audio' : 'Onyx'}</span>
                </div>
                <button onclick="downloadAudio('${iteration.audioId}')" class="text-gray-500 hover:text-green-600">
                    <i class="fas fa-download"></i>
                </button>
            </div>
        </div>
    `;
    
    document.getElementById('iterations-list').appendChild(div);
}

function selectIteration(index) {
    selectedIndex = index;
    
    document.querySelectorAll('.iteration').forEach((el, i) => {
        if (i === index) {
            el.classList.add('ring-2', 'ring-blue-500', 'bg-blue-50');
            el.classList.remove('hover:bg-gray-50');
        } else {
            el.classList.remove('ring-2', 'ring-blue-500', 'bg-blue-50');
            el.classList.add('hover:bg-gray-50');
        }
    });
    
    updateApplyButton();
}

function updateApplyButton() {
    const btn = document.getElementById('apply-btn');
    if (selectedIndex !== null && iterations[selectedIndex]) {
        const iteration = iterations[selectedIndex];
        btn.disabled = iteration.isCurrent;
        btn.textContent = iteration.isCurrent ? 'Current Selected' : 'Apply Selected';
    } else {
        btn.disabled = true;
        btn.textContent = 'Select an iteration';
    }
}

function playAudio(audioId, button, event) {
    if (event) event.stopPropagation();
    
    const icon = button.querySelector('i');
    
    // Check if this button already has audio playing
    if (button._audio && !button._audio.paused) {
        // Pause the current audio
        button._audio.pause();
        icon.className = 'fas fa-play text-xs';
        return;
    }
    
    // Stop all other audio and reset their buttons
    document.querySelectorAll('[onclick*="playAudio"]').forEach(btn => {
        if (btn !== button && btn._audio) {
            btn._audio.pause();
            btn.querySelector('i').className = 'fas fa-play text-xs';
        }
    });
    
    // Create new audio if doesn't exist
    if (!button._audio) {
        button._audio = new Audio(`/project/${modalData.projectId}/verse-audio/${audioId}/download`);
        
        button._audio.onended = () => {
            icon.className = 'fas fa-play text-xs';
        };
        
        button._audio.onerror = () => {
            icon.className = 'fas fa-play text-xs';
            alert('Failed to play audio');
        };
    }
    
    // Play the audio
    icon.className = 'fas fa-spinner fa-spin text-xs';
    
    button._audio.onloadeddata = () => {
        icon.className = 'fas fa-pause text-xs';
        button._audio.play();
    };
    
    // If already loaded, play immediately
    if (button._audio.readyState >= 2) {
        icon.className = 'fas fa-pause text-xs';
        button._audio.play();
    }
}

function downloadAudio(audioId, event) {
    if (event) event.stopPropagation();
    
    const a = document.createElement('a');
    a.href = `/project/${modalData.projectId}/verse-audio/${audioId}/download`;
    a.download = `audio_${audioId}.mp3`;
    a.click();
}

async function applySelected() {
    if (selectedIndex === null || !iterations[selectedIndex]) return;
    
    const iteration = iterations[selectedIndex];
    
    if (!iteration.isCurrent) {
        try {
            const response = await fetch(`/project/${modalData.projectId}/verse-audio/${modalData.textId}/${modalData.verseIndex}/apply`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ audioId: iteration.audioId })
            });
            
            if (response.ok && modalData.onApply) {
                modalData.onApply(iteration.audioId);
            }
        } catch (error) {
            console.error('Error applying changes:', error);
            alert('Failed to apply changes');
            return;
        }
    }
    
    closeModal();
}

async function deleteAllAudio() {
    if (!confirm('Delete all audio for this verse?')) return;
    
    try {
        const response = await fetch(`/project/${modalData.projectId}/verse-audio/${modalData.textId}/${modalData.verseIndex}/check`);
        const data = await response.json();
        
        if (data.exists) {
            const deleteResponse = await fetch(`/project/${modalData.projectId}/verse-audio/${data.audio_id}`, {
                method: 'DELETE'
            });
            
            if (deleteResponse.ok && modalData.onApply) {
                modalData.onApply(null);
            }
        }
    } catch (error) {
        console.error('Error deleting audio:', error);
    }
    
    closeModal();
}

async function loadVoiceProfile() {
    try {
        const response = await fetch(`/project/${modalData.projectId}/voice-profile`);
        const data = await response.json();
        
        if (data.success) {
            const profileInput = document.getElementById('voice-profile-input');
            profileInput.value = data.voice_profile || '';
            updateProfileCharCounter();
        }
    } catch (error) {
        console.error('Error loading voice profile:', error);
    }
}

async function saveVoiceProfile(showFeedback = true) {
    const profileInput = document.getElementById('voice-profile-input');
    
    try {
        const response = await fetch(`/project/${modalData.projectId}/voice-profile`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ voice_profile: profileInput.value.trim() })
        });
        
        const data = await response.json();
        
        if (!data.success) {
            throw new Error(data.error || 'Failed to save voice profile');
        }
        
        return true;
    } catch (error) {
        console.error('Error saving voice profile:', error);
        if (showFeedback) {
            alert('Failed to save voice profile');
        }
        return false;
    }
}

function setupVoiceProfileListeners() {
    const profileInput = document.getElementById('voice-profile-input');
    
    profileInput.addEventListener('input', updateProfileCharCounter);
    profileInput.addEventListener('keydown', (e) => {
        if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
            generateIteration();
        }
    });
}

function updateProfileCharCounter() {
    const profileInput = document.getElementById('voice-profile-input');
    const counter = document.querySelector('.profile-char-counter');
    const length = profileInput.value.length;
    
    counter.textContent = `${length}/500`;
    
    if (length > 450) {
        counter.classList.add('text-red-500');
        counter.classList.remove('text-blue-500');
    } else {
        counter.classList.add('text-blue-500');
        counter.classList.remove('text-red-500');
    }
}

// Voice selection removed - always use onyx
</script>
{% endmacro %} 