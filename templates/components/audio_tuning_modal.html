{% macro audio_tuning_modal() %}
<div id="audio-tuning-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full max-h-[90vh] flex flex-col">
            <div class="flex items-center justify-between p-4 border-b">
                <h3 class="text-lg font-semibold">Fine-tune Audio</h3>
                <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="p-4 bg-gray-50 border-b">
                <div class="text-sm text-gray-600 mb-1">Original Text:</div>
                <div id="original-text" class="text-gray-900 font-medium"></div>
            </div>
            
            <!-- Chat-like iterations list -->
            <div class="flex-1 overflow-y-auto p-4 space-y-3" id="iterations-list">
                <!-- Iterations will be added here -->
            </div>
            
            <!-- Input area -->
            <div class="border-t p-4">
                <div class="flex items-center space-x-2 mb-3">
                    <select id="voice-select" class="border rounded px-3 py-2 text-sm">
                        <option value="alloy">Alloy</option>
                        <option value="echo">Echo</option>
                        <option value="fable">Fable</option>
                        <option value="onyx" selected>Onyx</option>
                        <option value="nova">Nova</option>
                        <option value="shimmer">Shimmer</option>
                    </select>
                    <span class="text-sm text-gray-500">Voice for next iteration</span>
                </div>
                <div class="flex space-x-2">
                    <input 
                        type="text" 
                        id="instructions-input" 
                        placeholder="Voice instructions (e.g., 'speak slowly', 'British accent', 'more excited')"
                        class="flex-1 border rounded px-3 py-2"
                        onkeypress="if(event.key==='Enter') generateIteration()"
                    >
                    <button onclick="generateIteration()" id="generate-btn" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
                        <i class="fas fa-play"></i>
                    </button>
                </div>
            </div>
            
            <!-- Footer -->
            <div class="flex justify-between items-center p-4 border-t bg-gray-50">
                <button onclick="deleteAllAudio()" class="px-4 py-2 text-red-600 hover:bg-red-50 rounded">
                    <i class="fas fa-trash mr-2"></i>Delete All Audio
                </button>
                <div class="flex space-x-2">
                    <button onclick="closeModal()" class="px-4 py-2 border rounded text-gray-600 hover:bg-gray-50">
                        Cancel
                    </button>
                    <button onclick="applySelected()" id="apply-btn" class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700" disabled>
                        Apply Selected
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let modalData = null;
let iterations = [];
let selectedIndex = null;

window.AudioTuningModal = {
    open: function(data) {
        modalData = data;
        iterations = [];
        selectedIndex = null;
        
        document.getElementById('original-text').textContent = data.originalText;
        document.getElementById('voice-select').value = localStorage.getItem('preferredVoice') || 'onyx';
        document.getElementById('instructions-input').value = '';
        document.getElementById('iterations-list').innerHTML = '';
        document.getElementById('audio-tuning-modal').classList.remove('hidden');
        
        loadCurrentAudio();
        updateApplyButton();
    }
};

function closeModal() {
    document.getElementById('audio-tuning-modal').classList.add('hidden');
    modalData = null;
    iterations = [];
    selectedIndex = null;
}

async function loadCurrentAudio() {
    try {
        const response = await fetch(`/project/${modalData.projectId}/verse-audio/${modalData.textId}/${modalData.verseIndex}/check`);
        const data = await response.json();
        
        if (data.exists) {
            addIteration({
                audioId: data.audio_id,
                prompt: 'Current audio',
                voice: 'current',
                isCurrent: true
            });
            selectIteration(0);
        }
    } catch (error) {
        console.error('Error loading current audio:', error);
    }
}

async function generateIteration() {
    const voice = document.getElementById('voice-select').value;
    const instructions = document.getElementById('instructions-input').value.trim();
    const btn = document.getElementById('generate-btn');
    
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
    
    try {
        const response = await fetch(`/project/${modalData.projectId}/verse-audio/${modalData.textId}/${modalData.verseIndex}/tts-iterate`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                text: modalData.originalText,
                voice: voice,
                instructions: instructions
            })
        });
        
        const data = await response.json();
        
        addIteration({
            audioId: data.audio_id,
            prompt: instructions || 'No instructions',
            voice: voice,
            isCurrent: false
        });
        
        selectIteration(iterations.length - 1);
        document.getElementById('instructions-input').value = '';
        
    } catch (error) {
        console.error('Error generating audio:', error);
        alert('Failed to generate audio');
    } finally {
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-play"></i>';
    }
}

function addIteration(iteration) {
    iterations.push(iteration);
    const index = iterations.length - 1;
    
    const div = document.createElement('div');
    div.className = 'iteration border rounded-lg p-3 cursor-pointer hover:bg-gray-50';
    div.dataset.index = index;
    div.onclick = () => selectIteration(index);
    
    div.innerHTML = `
        <div class="flex items-start justify-between mb-2">
            <div class="flex items-center space-x-2">
                <div class="w-2 h-2 rounded-full ${iteration.isCurrent ? 'bg-green-500' : 'bg-blue-500'}"></div>
                <span class="text-sm font-medium">${iteration.isCurrent ? 'Current' : iteration.voice}</span>
                ${iteration.isCurrent ? '<span class="text-xs bg-green-100 text-green-800 px-2 py-1 rounded">Original</span>' : ''}
            </div>
            <span class="text-xs text-gray-500">${new Date().toLocaleTimeString()}</span>
        </div>
        <div class="text-sm text-gray-700 mb-3">${iteration.prompt}</div>
        
        <div class="bg-gray-50 rounded p-3">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-2">
                    <button onclick="playAudio('${iteration.audioId}', this)" class="w-8 h-8 bg-blue-500 text-white rounded-full hover:bg-blue-600 flex items-center justify-center">
                        <i class="fas fa-play text-xs"></i>
                    </button>
                    <span class="text-xs text-gray-600">${iteration.isCurrent ? 'Current Audio' : iteration.voice}</span>
                </div>
                <button onclick="downloadAudio('${iteration.audioId}')" class="text-gray-500 hover:text-green-600">
                    <i class="fas fa-download"></i>
                </button>
            </div>
        </div>
    `;
    
    document.getElementById('iterations-list').appendChild(div);
}

function selectIteration(index) {
    selectedIndex = index;
    
    document.querySelectorAll('.iteration').forEach((el, i) => {
        if (i === index) {
            el.classList.add('ring-2', 'ring-blue-500', 'bg-blue-50');
            el.classList.remove('hover:bg-gray-50');
        } else {
            el.classList.remove('ring-2', 'ring-blue-500', 'bg-blue-50');
            el.classList.add('hover:bg-gray-50');
        }
    });
    
    updateApplyButton();
}

function updateApplyButton() {
    const btn = document.getElementById('apply-btn');
    if (selectedIndex !== null && iterations[selectedIndex]) {
        const iteration = iterations[selectedIndex];
        btn.disabled = iteration.isCurrent;
        btn.textContent = iteration.isCurrent ? 'Current Selected' : 'Apply Selected';
    } else {
        btn.disabled = true;
        btn.textContent = 'Select an iteration';
    }
}

function playAudio(audioId, button, event) {
    if (event) event.stopPropagation();
    
    const icon = button.querySelector('i');
    
    // Check if this button already has audio playing
    if (button._audio && !button._audio.paused) {
        // Pause the current audio
        button._audio.pause();
        icon.className = 'fas fa-play text-xs';
        return;
    }
    
    // Stop all other audio and reset their buttons
    document.querySelectorAll('[onclick*="playAudio"]').forEach(btn => {
        if (btn !== button && btn._audio) {
            btn._audio.pause();
            btn.querySelector('i').className = 'fas fa-play text-xs';
        }
    });
    
    // Create new audio if doesn't exist
    if (!button._audio) {
        button._audio = new Audio(`/project/${modalData.projectId}/verse-audio/${audioId}/download`);
        
        button._audio.onended = () => {
            icon.className = 'fas fa-play text-xs';
        };
        
        button._audio.onerror = () => {
            icon.className = 'fas fa-play text-xs';
            alert('Failed to play audio');
        };
    }
    
    // Play the audio
    icon.className = 'fas fa-spinner fa-spin text-xs';
    
    button._audio.onloadeddata = () => {
        icon.className = 'fas fa-pause text-xs';
        button._audio.play();
    };
    
    // If already loaded, play immediately
    if (button._audio.readyState >= 2) {
        icon.className = 'fas fa-pause text-xs';
        button._audio.play();
    }
}

function downloadAudio(audioId, event) {
    if (event) event.stopPropagation();
    
    const a = document.createElement('a');
    a.href = `/project/${modalData.projectId}/verse-audio/${audioId}/download`;
    a.download = `audio_${audioId}.mp3`;
    a.click();
}

async function applySelected() {
    if (selectedIndex === null || !iterations[selectedIndex]) return;
    
    const iteration = iterations[selectedIndex];
    
    if (!iteration.isCurrent) {
        try {
            const response = await fetch(`/project/${modalData.projectId}/verse-audio/${modalData.textId}/${modalData.verseIndex}/apply`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ audioId: iteration.audioId })
            });
            
            if (response.ok && modalData.onApply) {
                modalData.onApply(iteration.audioId);
            }
        } catch (error) {
            console.error('Error applying changes:', error);
            alert('Failed to apply changes');
            return;
        }
    }
    
    closeModal();
}

async function deleteAllAudio() {
    if (!confirm('Delete all audio for this verse?')) return;
    
    try {
        const response = await fetch(`/project/${modalData.projectId}/verse-audio/${modalData.textId}/${modalData.verseIndex}/check`);
        const data = await response.json();
        
        if (data.exists) {
            const deleteResponse = await fetch(`/project/${modalData.projectId}/verse-audio/${data.audio_id}`, {
                method: 'DELETE'
            });
            
            if (deleteResponse.ok && modalData.onApply) {
                modalData.onApply(null);
            }
        }
    } catch (error) {
        console.error('Error deleting audio:', error);
    }
    
    closeModal();
}
</script>
{% endmacro %} 