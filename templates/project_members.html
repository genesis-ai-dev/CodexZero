{% extends "base.html" %}
{% block title %}Project Members - {{ project.target_language }}{% endblock %}

{% block content %}
<div class="min-h-screen">
    <div class="max-w-6xl mx-auto px-4 sm:px-6 py-4 sm:py-8">
        <!-- Header Card -->
        <div class="bg-white/80 backdrop-blur-sm rounded-2xl shadow-lg border border-white/20 p-4 sm:p-8 mb-6 sm:mb-8">
            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
                <div>
                    <h1 class="text-2xl sm:text-3xl font-bold text-neutral-900 mb-2">Project Members</h1>
                    <p class="text-neutral-600 font-medium text-base sm:text-lg">{{ project.target_language }} for {{ project.audience }}</p>
                </div>
                <div class="flex-shrink-0">
                    <a href="{{ url_for('projects.view_project', project_id=project.id) }}" 
                       class="inline-flex items-center justify-center w-full sm:w-auto px-4 sm:px-6 py-3 bg-white text-neutral-700 border border-neutral-300 rounded-xl font-semibold hover:bg-neutral-50 transition-all duration-200 shadow-md">
                        <i class="fas fa-arrow-left mr-2"></i>
                        Back to Project
                    </a>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 sm:gap-8">
            <!-- Members List -->
            <div class="lg:col-span-2">
                <div class="bg-white/80 backdrop-blur-sm rounded-2xl shadow-lg border border-white/20">
                    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between p-4 sm:p-6 border-b border-neutral-200 gap-4">
                        <h2 class="text-lg sm:text-xl font-bold text-neutral-900">Current Members</h2>
                        <button onclick="showAddMemberForm()" 
                                class="w-full sm:w-auto px-4 sm:px-6 py-3 bg-gradient-to-r from-blue-600 to-blue-700 text-white hover:from-blue-700 hover:to-blue-800 rounded-xl font-semibold transition-all duration-200 transform hover:scale-105 shadow-lg">
                            <i class="fas fa-user-plus mr-2"></i>
                            Add Member
                        </button>
                    </div>
                    <div class="p-4 sm:p-6">
                        <div id="members-list" class="space-y-4">
                            {% for member, user in members %}
                            <div class="member-item bg-neutral-50/80 rounded-xl p-3 sm:p-4 border border-neutral-200 hover:shadow-md transition-all duration-200" data-user-id="{{ user.id }}">
                                <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 sm:gap-0">
                                    <div class="flex items-center">
                                        <div class="w-10 h-10 sm:w-12 sm:h-12 bg-blue-100 rounded-lg flex items-center justify-center mr-3 sm:mr-4 flex-shrink-0">
                                            <i class="fas fa-user text-blue-600 text-base sm:text-lg"></i>
                                        </div>
                                        <div class="min-w-0 flex-1">
                                            <div class="font-semibold text-neutral-900 truncate">{{ user.name or user.email }}</div>
                                            {% if user.name %}
                                                <div class="text-sm text-neutral-600 truncate">{{ user.email }}</div>
                                            {% endif %}
                                            <div class="text-xs text-neutral-500 mt-1">
                                                {% if member.role == 'owner' %}
                                                    <span class="bg-purple-100 text-purple-700 px-2 py-1 rounded-lg font-medium">Owner</span>
                                                {% elif member.role == 'editor' %}
                                                    <span class="bg-green-100 text-green-700 px-2 py-1 rounded-lg font-medium">Editor</span>
                                                {% else %}
                                                    <span class="bg-blue-100 text-blue-700 px-2 py-1 rounded-lg font-medium">Viewer</span>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                    <div class="flex items-center gap-2 sm:gap-3 flex-wrap sm:flex-nowrap">
                                        <select class="flex-1 sm:flex-none border border-neutral-300 rounded-lg px-2 sm:px-3 py-2 text-sm font-medium bg-white focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors min-w-0" 
                                                onchange="updateMemberRole({{ user.id }}, this.value)">
                                            <option value="viewer" {% if member.role == 'viewer' %}selected{% endif %}>Viewer</option>
                                            <option value="editor" {% if member.role == 'editor' %}selected{% endif %}>Editor</option>
                                            <option value="owner" {% if member.role == 'owner' %}selected{% endif %}>Owner</option>
                                        </select>
                                        <button onclick="removeMember({{ user.id }}, '{{ user.name or user.email }}')" 
                                                class="flex-1 sm:flex-none px-3 sm:px-4 py-2 text-sm border border-red-300 text-red-600 hover:bg-red-50 rounded-lg font-semibold transition-all duration-200 whitespace-nowrap">
                                            <i class="fas fa-trash mr-1"></i>
                                            <span class="hidden sm:inline">Remove</span>
                                            <span class="sm:hidden">Del</span>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Role Permissions -->
            <div class="lg:col-span-1">
                <div class="bg-white/80 backdrop-blur-sm rounded-2xl shadow-lg border border-white/20">
                    <div class="p-4 sm:p-6 border-b border-neutral-200">
                        <h3 class="text-lg font-bold text-neutral-900">Role Permissions</h3>
                    </div>
                    <div class="p-4 sm:p-6 space-y-4 sm:space-y-6">
                        <div class="bg-purple-50/80 rounded-xl p-3 sm:p-4 border border-purple-200">
                            <div class="flex items-center mb-3">
                                <div class="w-8 h-8 bg-purple-100 rounded-lg flex items-center justify-center mr-3 flex-shrink-0">
                                    <i class="fas fa-crown text-purple-600"></i>
                                </div>
                                <div class="font-semibold text-purple-900">Owner</div>
                            </div>
                            <ul class="text-sm text-purple-700 space-y-1 ml-2">
                                <li class="flex items-center"><i class="fas fa-check text-purple-600 mr-2 text-xs flex-shrink-0"></i>All editor permissions</li>
                                <li class="flex items-center"><i class="fas fa-check text-purple-600 mr-2 text-xs flex-shrink-0"></i>Manage members</li>
                                <li class="flex items-center"><i class="fas fa-check text-purple-600 mr-2 text-xs flex-shrink-0"></i>Delete project</li>
                            </ul>
                        </div>
                        <div class="bg-green-50/80 rounded-xl p-3 sm:p-4 border border-green-200">
                            <div class="flex items-center mb-3">
                                <div class="w-8 h-8 bg-green-100 rounded-lg flex items-center justify-center mr-3 flex-shrink-0">
                                    <i class="fas fa-edit text-green-600"></i>
                                </div>
                                <div class="font-semibold text-green-900">Editor</div>
                            </div>
                            <ul class="text-sm text-green-700 space-y-1 ml-2">
                                <li class="flex items-center"><i class="fas fa-check text-green-600 mr-2 text-xs flex-shrink-0"></i>All viewer permissions</li>
                                <li class="flex items-center"><i class="fas fa-check text-green-600 mr-2 text-xs flex-shrink-0"></i>Edit translations</li>
                                <li class="flex items-center"><i class="fas fa-check text-green-600 mr-2 text-xs flex-shrink-0"></i>Upload files</li>
                                <li class="flex items-center"><i class="fas fa-check text-green-600 mr-2 text-xs flex-shrink-0"></i>Manage fine-tuning</li>
                            </ul>
                        </div>
                        <div class="bg-blue-50/80 rounded-xl p-3 sm:p-4 border border-blue-200">
                            <div class="flex items-center mb-3">
                                <div class="w-8 h-8 bg-blue-100 rounded-lg flex items-center justify-center mr-3 flex-shrink-0">
                                    <i class="fas fa-eye text-blue-600"></i>
                                </div>
                                <div class="font-semibold text-blue-900">Viewer</div>
                            </div>
                            <ul class="text-sm text-blue-700 space-y-1 ml-2">
                                <li class="flex items-center"><i class="fas fa-check text-blue-600 mr-2 text-xs flex-shrink-0"></i>View project</li>
                                <li class="flex items-center"><i class="fas fa-check text-blue-600 mr-2 text-xs flex-shrink-0"></i>Download files</li>
                                <li class="flex items-center"><i class="fas fa-check text-blue-600 mr-2 text-xs flex-shrink-0"></i>View translations</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Member Modal -->
<div id="addMemberModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50 p-4">
    <div class="bg-white/95 backdrop-blur-sm rounded-2xl shadow-2xl border border-white/20 max-w-md w-full">
        <div class="flex items-center justify-between p-4 sm:p-6 border-b border-neutral-200">
            <h3 class="text-lg sm:text-xl font-bold text-neutral-900">Add Project Member</h3>
            <button onclick="hideAddMemberForm()" class="text-neutral-500 hover:text-neutral-700 p-2 hover:bg-neutral-100 rounded-lg transition-colors">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="p-4 sm:p-6">
            <form id="addMemberForm">
                <div class="mb-6">
                    <label for="memberEmail" class="block text-sm font-semibold text-neutral-700 mb-2">
                        Email Address
                    </label>
                    <input type="email" id="memberEmail" 
                           class="w-full border border-neutral-300 rounded-lg px-4 py-3 bg-white focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors"
                           placeholder="Enter user's email address" required>
                    <div class="text-xs text-neutral-500 mt-2 bg-neutral-50 rounded-lg p-2">
                        <i class="fas fa-info-circle mr-1"></i>
                        User must already have an account
                    </div>
                </div>
                <div class="mb-6">
                    <label for="memberRole" class="block text-sm font-semibold text-neutral-700 mb-2">
                        Role
                    </label>
                    <select id="memberRole" 
                            class="w-full border border-neutral-300 rounded-lg px-4 py-3 bg-white focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors" 
                            required>
                        <option value="viewer">Viewer</option>
                        <option value="editor">Editor</option>
                        <option value="owner">Owner</option>
                    </select>
                </div>
            </form>
        </div>
        <div class="flex flex-col sm:flex-row justify-end gap-3 p-4 sm:p-6 border-t border-neutral-200">
            <button onclick="hideAddMemberForm()" 
                    class="w-full sm:w-auto px-6 py-3 bg-white text-neutral-700 border border-neutral-300 rounded-xl font-semibold hover:bg-neutral-50 transition-all duration-200 order-2 sm:order-1">
                Cancel
            </button>
            <button onclick="addMember()" 
                    class="w-full sm:w-auto px-6 py-3 bg-gradient-to-r from-blue-600 to-blue-700 text-white hover:from-blue-700 hover:to-blue-800 rounded-xl font-semibold transition-all duration-200 transform hover:scale-105 shadow-lg order-1 sm:order-2">
                <i class="fas fa-user-plus mr-2"></i>
                Add Member
            </button>
        </div>
    </div>
</div>

<script>
const projectId = {{ project.id }};

function showAddMemberForm() {
    document.getElementById('addMemberModal').classList.remove('hidden');
}

function hideAddMemberForm() {
    document.getElementById('addMemberModal').classList.add('hidden');
    document.getElementById('addMemberForm').reset();
}

async function addMember() {
    const email = document.getElementById('memberEmail').value.trim();
    const role = document.getElementById('memberRole').value;
    
    if (!email) {
        alert('Please enter an email address');
        return;
    }
    
    try {
        const response = await fetch(`/project/${projectId}/members/add`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ email, role })
        });
        
        const data = await response.json();
        
        if (data.success) {
            // Add member to the list
            const membersList = document.getElementById('members-list');
            const roleColor = role === 'owner' ? 'purple' : role === 'editor' ? 'green' : 'blue';
            const memberHtml = `
                <div class="member-item bg-neutral-50/80 rounded-xl p-3 sm:p-4 border border-neutral-200 hover:shadow-md transition-all duration-200" data-user-id="${data.member.id}">
                    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 sm:gap-0">
                        <div class="flex items-center">
                            <div class="w-10 h-10 sm:w-12 sm:h-12 bg-blue-100 rounded-lg flex items-center justify-center mr-3 sm:mr-4 flex-shrink-0">
                                <i class="fas fa-user text-blue-600 text-base sm:text-lg"></i>
                            </div>
                            <div class="min-w-0 flex-1">
                                <div class="font-semibold text-neutral-900 truncate">${data.member.name}</div>
                                ${data.member.name !== data.member.email ? `<div class="text-sm text-neutral-600 truncate">${data.member.email}</div>` : ''}
                                <div class="text-xs text-neutral-500 mt-1">
                                    <span class="bg-${roleColor}-100 text-${roleColor}-700 px-2 py-1 rounded-lg font-medium">${role.charAt(0).toUpperCase() + role.slice(1)}</span>
                                </div>
                            </div>
                        </div>
                        <div class="flex items-center gap-2 sm:gap-3 flex-wrap sm:flex-nowrap">
                            <select class="flex-1 sm:flex-none border border-neutral-300 rounded-lg px-2 sm:px-3 py-2 text-sm font-medium bg-white focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors min-w-0" 
                                    onchange="updateMemberRole(${data.member.id}, this.value)">
                                <option value="viewer" ${role === 'viewer' ? 'selected' : ''}>Viewer</option>
                                <option value="editor" ${role === 'editor' ? 'selected' : ''}>Editor</option>
                                <option value="owner" ${role === 'owner' ? 'selected' : ''}>Owner</option>
                            </select>
                            <button onclick="removeMember(${data.member.id}, '${data.member.name}')" 
                                    class="flex-1 sm:flex-none px-3 sm:px-4 py-2 text-sm border border-red-300 text-red-600 hover:bg-red-50 rounded-lg font-semibold transition-all duration-200 whitespace-nowrap">
                                <i class="fas fa-trash mr-1"></i>
                                <span class="hidden sm:inline">Remove</span>
                                <span class="sm:hidden">Del</span>
                            </button>
                        </div>
                    </div>
                </div>
            `;
            membersList.insertAdjacentHTML('beforeend', memberHtml);
            
            // Close modal and reset form
            hideAddMemberForm();
            alert(data.message);
        } else {
            alert(data.error || 'Failed to add member');
        }
    } catch (error) {
        console.error('Error adding member:', error);
        alert('Failed to add member. Please try again.');
    }
}

async function updateMemberRole(userId, newRole) {
    try {
        const response = await fetch(`/project/${projectId}/members/${userId}/role`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ role: newRole })
        });
        
        const data = await response.json();
        
        if (data.success) {
            alert(data.message);
            // Update the role badge
            const memberElement = document.querySelector(`[data-user-id="${userId}"]`);
            if (memberElement) {
                const roleColor = newRole === 'owner' ? 'purple' : newRole === 'editor' ? 'green' : 'blue';
                const roleBadge = memberElement.querySelector('.text-xs span');
                if (roleBadge) {
                    roleBadge.className = `bg-${roleColor}-100 text-${roleColor}-700 px-2 py-1 rounded-lg font-medium`;
                    roleBadge.textContent = newRole.charAt(0).toUpperCase() + newRole.slice(1);
                }
            }
        } else {
            alert(data.error || 'Failed to update role');
            // Reload page to reset the select
            location.reload();
        }
    } catch (error) {
        console.error('Error updating role:', error);
        alert('Failed to update role. Please try again.');
        location.reload();
    }
}

async function removeMember(userId, userName) {
    if (!confirm(`Are you sure you want to remove ${userName} from this project?`)) {
        return;
    }
    
    try {
        const response = await fetch(`/project/${projectId}/members/${userId}`, {
            method: 'DELETE'
        });
        
        const data = await response.json();
        
        if (data.success) {
            // Remove from DOM
            const memberElement = document.querySelector(`[data-user-id="${userId}"]`);
            if (memberElement) {
                memberElement.remove();
            }
            alert(data.message);
        } else {
            alert(data.error || 'Failed to remove member');
        }
    } catch (error) {
        console.error('Error removing member:', error);
        alert('Failed to remove member. Please try again.');
    }
}

// Close modal when clicking outside
document.getElementById('addMemberModal').addEventListener('click', function(e) {
    if (e.target === this) {
        hideAddMemberForm();
    }
});
</script>
{% endblock %} 