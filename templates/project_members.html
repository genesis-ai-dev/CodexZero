{% extends "base.html" %}
{% block title %}Project Members - {{ project.target_language }}{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto px-6 py-8">
    <div class="flex items-center justify-between mb-8">
        <div>
            <h1 class="text-3xl font-bold text-gray-900 mb-2">Project Members</h1>
            <p class="text-gray-600">{{ project.target_language }} for {{ project.audience }}</p>
        </div>
        <div>
            <a href="{{ url_for('projects.view_project', project_id=project.id) }}" 
               class="inline-flex items-center px-4 py-2 border-2 border-gray-300 text-gray-700 hover:bg-gray-50 font-medium transition-colors">
                <i class="fas fa-arrow-left mr-2"></i>
                Back to Project
            </a>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <!-- Members List -->
        <div class="lg:col-span-2">
            <div class="paper-white border-2 border-gray-900">
                <div class="flex items-center justify-between p-4 border-b border-gray-200">
                    <h2 class="text-xl font-bold text-gray-900">Current Members</h2>
                    <button onclick="showAddMemberForm()" 
                            class="btn-marker text-sm">
                        Add Member
                    </button>
                </div>
                <div class="p-4">
                    <div id="members-list" class="space-y-4">
                        {% for member, user in members %}
                        <div class="member-item border-b border-gray-100 pb-4 last:border-b-0 last:pb-0" data-user-id="{{ user.id }}">
                            <div class="flex items-center justify-between">
                                <div>
                                    <div class="font-semibold text-gray-900">{{ user.name or user.email }}</div>
                                    {% if user.name %}
                                        <div class="text-sm text-gray-500">{{ user.email }}</div>
                                    {% endif %}
                                </div>
                                <div class="flex items-center gap-3">
                                    <select class="border border-gray-300 rounded px-3 py-1 text-sm font-medium focus:outline-none focus:ring-2 focus:ring-blue-500" 
                                            onchange="updateMemberRole({{ user.id }}, this.value)">
                                        <option value="viewer" {% if member.role == 'viewer' %}selected{% endif %}>Viewer</option>
                                        <option value="editor" {% if member.role == 'editor' %}selected{% endif %}>Editor</option>
                                        <option value="owner" {% if member.role == 'owner' %}selected{% endif %}>Owner</option>
                                    </select>
                                    <button onclick="removeMember({{ user.id }}, '{{ user.name or user.email }}')" 
                                            class="px-3 py-1 text-sm border border-red-300 text-red-600 hover:bg-red-50 font-medium transition-colors">
                                        Remove
                                    </button>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Role Permissions -->
        <div class="lg:col-span-1">
            <div class="paper-white border-2 border-gray-900">
                <div class="p-4 border-b border-gray-200">
                    <h3 class="text-lg font-bold text-gray-900">Role Permissions</h3>
                </div>
                <div class="p-4 space-y-4">
                    <div>
                        <div class="font-semibold text-gray-900 mb-2">Owner</div>
                        <ul class="text-sm text-gray-600 space-y-1 ml-4">
                            <li>• All editor permissions</li>
                            <li>• Manage members</li>
                            <li>• Delete project</li>
                        </ul>
                    </div>
                    <div>
                        <div class="font-semibold text-gray-900 mb-2">Editor</div>
                        <ul class="text-sm text-gray-600 space-y-1 ml-4">
                            <li>• All viewer permissions</li>
                            <li>• Edit translations</li>
                            <li>• Upload files</li>
                            <li>• Manage fine-tuning</li>
                        </ul>
                    </div>
                    <div>
                        <div class="font-semibold text-gray-900 mb-2">Viewer</div>
                        <ul class="text-sm text-gray-600 space-y-1 ml-4">
                            <li>• View project</li>
                            <li>• Download files</li>
                            <li>• View translations</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Member Modal -->
<div id="addMemberModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
    <div class="bg-white border-2 border-gray-900 max-w-md w-full mx-4">
        <div class="flex items-center justify-between p-4 border-b border-gray-200">
            <h3 class="text-lg font-bold text-gray-900">Add Project Member</h3>
            <button onclick="hideAddMemberForm()" class="text-gray-500 hover:text-gray-700">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="p-4">
            <form id="addMemberForm">
                <div class="mb-4">
                    <label for="memberEmail" class="block text-sm font-medium text-gray-700 mb-2">
                        Email Address
                    </label>
                    <input type="email" id="memberEmail" 
                           class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                           placeholder="Enter user's email address" required>
                    <div class="text-xs text-gray-500 mt-1">User must already have an account</div>
                </div>
                <div class="mb-4">
                    <label for="memberRole" class="block text-sm font-medium text-gray-700 mb-2">
                        Role
                    </label>
                    <select id="memberRole" 
                            class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" 
                            required>
                        <option value="viewer">Viewer</option>
                        <option value="editor">Editor</option>
                        <option value="owner">Owner</option>
                    </select>
                </div>
            </form>
        </div>
        <div class="flex justify-end gap-3 p-4 border-t border-gray-200">
            <button onclick="hideAddMemberForm()" 
                    class="px-4 py-2 border border-gray-300 text-gray-700 hover:bg-gray-50 font-medium transition-colors">
                Cancel
            </button>
            <button onclick="addMember()" 
                    class="btn-marker text-sm">
                Add Member
            </button>
        </div>
    </div>
</div>

<script>
const projectId = {{ project.id }};

function showAddMemberForm() {
    document.getElementById('addMemberModal').classList.remove('hidden');
}

function hideAddMemberForm() {
    document.getElementById('addMemberModal').classList.add('hidden');
    document.getElementById('addMemberForm').reset();
}

async function addMember() {
    const email = document.getElementById('memberEmail').value.trim();
    const role = document.getElementById('memberRole').value;
    
    if (!email) {
        alert('Please enter an email address');
        return;
    }
    
    try {
        const response = await fetch(`/project/${projectId}/members/add`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ email, role })
        });
        
        const data = await response.json();
        
        if (data.success) {
            // Add member to the list
            const membersList = document.getElementById('members-list');
            const memberHtml = `
                <div class="member-item border-b border-gray-100 pb-4" data-user-id="${data.member.id}">
                    <div class="flex items-center justify-between">
                        <div>
                            <div class="font-semibold text-gray-900">${data.member.name}</div>
                            ${data.member.name !== data.member.email ? `<div class="text-sm text-gray-500">${data.member.email}</div>` : ''}
                        </div>
                        <div class="flex items-center gap-3">
                            <select class="border border-gray-300 rounded px-3 py-1 text-sm font-medium focus:outline-none focus:ring-2 focus:ring-blue-500" 
                                    onchange="updateMemberRole(${data.member.id}, this.value)">
                                <option value="viewer" ${role === 'viewer' ? 'selected' : ''}>Viewer</option>
                                <option value="editor" ${role === 'editor' ? 'selected' : ''}>Editor</option>
                                <option value="owner" ${role === 'owner' ? 'selected' : ''}>Owner</option>
                            </select>
                            <button onclick="removeMember(${data.member.id}, '${data.member.name}')" 
                                    class="px-3 py-1 text-sm border border-red-300 text-red-600 hover:bg-red-50 font-medium transition-colors">
                                Remove
                            </button>
                        </div>
                    </div>
                </div>
            `;
            membersList.insertAdjacentHTML('beforeend', memberHtml);
            
            // Close modal and reset form
            hideAddMemberForm();
            alert(data.message);
        } else {
            alert(data.error || 'Failed to add member');
        }
    } catch (error) {
        console.error('Error adding member:', error);
        alert('Failed to add member. Please try again.');
    }
}

async function updateMemberRole(userId, newRole) {
    try {
        const response = await fetch(`/project/${projectId}/members/${userId}/role`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ role: newRole })
        });
        
        const data = await response.json();
        
        if (data.success) {
            alert(data.message);
        } else {
            alert(data.error || 'Failed to update role');
            // Reload page to reset the select
            location.reload();
        }
    } catch (error) {
        console.error('Error updating role:', error);
        alert('Failed to update role. Please try again.');
        location.reload();
    }
}

async function removeMember(userId, userName) {
    if (!confirm(`Are you sure you want to remove ${userName} from this project?`)) {
        return;
    }
    
    try {
        const response = await fetch(`/project/${projectId}/members/${userId}`, {
            method: 'DELETE'
        });
        
        const data = await response.json();
        
        if (data.success) {
            // Remove from DOM
            const memberElement = document.querySelector(`[data-user-id="${userId}"]`);
            if (memberElement) {
                memberElement.remove();
            }
            alert(data.message);
        } else {
            alert(data.error || 'Failed to remove member');
        }
    } catch (error) {
        console.error('Error removing member:', error);
        alert('Failed to remove member. Please try again.');
    }
}

// Close modal when clicking outside
document.getElementById('addMemberModal').addEventListener('click', function(e) {
    if (e.target === this) {
        hideAddMemberForm();
    }
});
</script>
{% endblock %} 